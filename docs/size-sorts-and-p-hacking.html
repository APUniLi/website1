<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 5 Size sorts and p-hacking | Tidy Finance with R</title>
<meta name="author" content="Christoph Scheuch, wikifolio Financial Technologies">
<meta name="author" content="Stefan Voigt, University of Copenhagen and Danish Finance Institute">
<meta name="author" content="Patrick Weiss, Vienna University of Economics and Business">
<meta name="description" content="In this chapter, we continue with portfolio sorts in a univariate setting. Yet, we consider firm size as a sorting variable, which gives rise to a well-known return factor: the size premium. The...">
<meta name="generator" content="bookdown 0.24.4 with bs4_book()">
<meta property="og:title" content="Chapter 5 Size sorts and p-hacking | Tidy Finance with R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://www.tidy-finance.org/size-sorts-and-p-hacking.html">
<meta property="og:image" content="https://www.tidy-finance.org/cover.jpg">
<meta property="og:description" content="In this chapter, we continue with portfolio sorts in a univariate setting. Yet, we consider firm size as a sorting variable, which gives rise to a well-known return factor: the size premium. The...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 5 Size sorts and p-hacking | Tidy Finance with R">
<meta name="twitter:description" content="In this chapter, we continue with portfolio sorts in a univariate setting. Yet, we consider firm size as a sorting variable, which gives rise to a well-known return factor: the size premium. The...">
<meta name="twitter:image" content="https://www.tidy-finance.org/cover.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-DH3KZSMJ5W"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-DH3KZSMJ5W');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Tidy Finance with R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="introduction-to-tidy-finance.html"><span class="header-section-number">1</span> Introduction to Tidy Finance</a></li>
<li><a class="" href="accessing-managing-financial-data.html"><span class="header-section-number">2</span> Accessing &amp; managing financial data</a></li>
<li><a class="" href="beta-estimation.html"><span class="header-section-number">3</span> Beta estimation</a></li>
<li><a class="" href="univariate-portfolio-sorts.html"><span class="header-section-number">4</span> Univariate portfolio sorts</a></li>
<li><a class="active" href="size-sorts-and-p-hacking.html"><span class="header-section-number">5</span> Size sorts and p-hacking</a></li>
<li><a class="" href="value-and-bivariate-sorts.html"><span class="header-section-number">6</span> Value and bivariate sorts</a></li>
<li><a class="" href="replicating-fama-french-factors.html"><span class="header-section-number">7</span> Replicating Fama &amp; French factors</a></li>
<li><a class="" href="factor-selection-via-machine-learning.html"><span class="header-section-number">8</span> Factor selection via machine learning</a></li>
<li><a class="" href="option-pricing-via-machine-learning.html"><span class="header-section-number">9</span> Option pricing via machine learning</a></li>
<li><a class="" href="parametric-portfolio-policies.html"><span class="header-section-number">10</span> Parametric portfolio policies</a></li>
<li><a class="" href="constrained-optimization-and-backtesting.html"><span class="header-section-number">11</span> Constrained optimization and backtesting</a></li>
<li><a class="" href="references.html">References</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="cover-design.html"><span class="header-section-number">A</span> Cover design</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/voigtstefan/tidy_finance">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="size-sorts-and-p-hacking" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Size sorts and p-hacking<a class="anchor" aria-label="anchor" href="#size-sorts-and-p-hacking"><i class="fas fa-link"></i></a>
</h1>
<p>In this chapter, we continue with portfolio sorts in a univariate setting. Yet, we consider firm size as a sorting variable, which gives rise to a well-known return factor: the size premium. The size premium arises from buying small stocks and selling large stocks. Prominently, <span class="citation"><a href="references.html#ref-Fama1993" role="doc-biblioref">Fama and French</a> (<a href="references.html#ref-Fama1993" role="doc-biblioref">1993</a>)</span> include it as a factor in their three-factor model. Apart from that, asset managers commonly include size as a key firm characteristic when making investment decisions.</p>
<p>We also introduce new choices in the formation of portfolios. In particular, we discuss listing exchanges, industries, weighting regimes, and periods. These choices matter for the portfolio returns and result in different size premiums. Exploiting these ideas to generate favorable results is called p-hacking.
There is arguably a thin line between p-hacking and conducting robustness tests, our purpose here is simply to illustrate the substantial variation which can arise along the evidence generating process.</p>
<div id="data-preparation-1" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Data preparation<a class="anchor" aria-label="anchor" href="#data-preparation-1"><i class="fas fa-link"></i></a>
</h2>
<p>The chapter relies on the following set of packages.</p>
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rsqlite.r-dbi.org">RSQLite</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sandwich.R-Forge.R-project.org/">sandwich</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">lmtest</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/furrr">furrr</a></span><span class="op">)</span></code></pre></div>
<p>First, we retrieve the relevant data from our database. Firm size is defined as market equity in most asset pricing applications that we retrieve from CRSP. We further use the Fama-French factor returns for performance evaluation.</p>
<div class="sourceCode" id="cb153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tidy_finance</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"data/tidy_finance.sqlite"</span>, extended_types <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">crsp_monthly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">tidy_finance</span>, <span class="st">"crsp_monthly"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">factors_ff_monthly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">tidy_finance</span>, <span class="st">"factors_ff_monthly"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="size-distribution" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Size distribution<a class="anchor" aria-label="anchor" href="#size-distribution"><i class="fas fa-link"></i></a>
</h2>
<p>Before we build our size portfolios, we investigate the distribution of the variable <em>firm size</em>. Visualizing the data is a valuable starting point to understand the input to the analysis. The figure below shows the fraction of total market capitalization concentrated in the largest firm. To produce this graph, we create monthly indicators that track whether a stock belongs to the largest x% of the firms.
Then, we aggregate the firms within each bucket and compute the buckets’ share of total market capitalization.</p>
<p>The figure shows that the largest 1% of firms cover up to 50% of the total market capitalization, and holding just the 25% largest firms in the CRSP universe essentially replicates the market portfolio. The distribution of firm size thus implies that the largest firms of the market dominate many small firms whenever we use value-weighted benchmarks.</p>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">crsp_monthly</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    top01 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">mktcap</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">mktcap</span>, <span class="fl">0.99</span><span class="op">)</span>, <span class="fl">1L</span>, <span class="fl">0L</span><span class="op">)</span>,
    top05 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">mktcap</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">mktcap</span>, <span class="fl">0.95</span><span class="op">)</span>, <span class="fl">1L</span>, <span class="fl">0L</span><span class="op">)</span>,
    top10 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">mktcap</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">mktcap</span>, <span class="fl">0.90</span><span class="op">)</span>, <span class="fl">1L</span>, <span class="fl">0L</span><span class="op">)</span>,
    top25 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">mktcap</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">mktcap</span>, <span class="fl">0.75</span><span class="op">)</span>, <span class="fl">1L</span>, <span class="fl">0L</span><span class="op">)</span>,
    total_market_cap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">mktcap</span><span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>
    `Largest 1% of stocks` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">mktcap</span><span class="op">[</span><span class="va">top01</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">total_market_cap</span>,
    `Largest 5% of stocks` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">mktcap</span><span class="op">[</span><span class="va">top05</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">total_market_cap</span>,
    `Largest 10% of stocks` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">mktcap</span><span class="op">[</span><span class="va">top10</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">total_market_cap</span>,
    `Largest 25% of stocks` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">mktcap</span><span class="op">[</span><span class="va">top25</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">total_market_cap</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="va">month</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">name</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"Largest 1% of stocks"</span>, <span class="st">"Largest 5% of stocks"</span>,
    <span class="st">"Largest 10% of stocks"</span>, <span class="st">"Largest 25% of stocks"</span>
  <span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">month</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">percent</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span>, color <span class="op">=</span> <span class="cn">NULL</span>,
    title <span class="op">=</span> <span class="st">"Percentage of total market capitalization in largest stocks"</span>
  <span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="33_size_and_portfolio_building_files/figure-html/unnamed-chunk-3-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Next, firm sizes also differ across listing exchanges. Stocks’ primary listings were important in the past and are potentially still relevant today. The graph below shows that the New York Stock Exchange (NYSE) was and still is the largest listing exchange in terms of market capitalization. More recently, NASDAQ has gained relevance as a listing exchange. Do you know what the small peak in NASDAQ’s market cap around the year 2000 was?</p>
<div class="sourceCode" id="cb155"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">crsp_monthly</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span>, <span class="va">exchange</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mktcap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">mktcap</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>share <span class="op">=</span> <span class="va">mktcap</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">mktcap</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">month</span>, y <span class="op">=</span> <span class="va">share</span>, fill <span class="op">=</span> <span class="va">exchange</span>, color <span class="op">=</span> <span class="va">exchange</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_area</a></span><span class="op">(</span>
    position <span class="op">=</span> <span class="st">"stack"</span>,
    stat <span class="op">=</span> <span class="st">"identity"</span>,
    alpha <span class="op">=</span> <span class="fl">0.5</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"stack"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">percent</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span>, fill <span class="op">=</span> <span class="cn">NULL</span>, color <span class="op">=</span> <span class="cn">NULL</span>,
    title <span class="op">=</span> <span class="st">"Share of total market capitalization per listing exchange"</span>
  <span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="33_size_and_portfolio_building_files/figure-html/unnamed-chunk-4-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Finally, we consider the distribution of firm size across listing exchanges and create summary statistics. The pre-build function <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> does not include all statistics we are interested in, which is why we create the function <code>create_summary()</code> that adds the standard deviation and the number of observations. Then, we apply it to the most current month of our CRSP data on each listing exchange. We also add a row with <code><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row()</a></code> with the overall summary statistics.</p>
<p>The resulting table shows that firms listed on NYSE are significantly larger on average than firms listed on the other exchanges. Moreover, NASDAQ lists the largest number of firms. This discrepancy between firm sizes across listing exchanges motivated researchers to form breakpoints exclusively on the NYSE sample and apply those breakpoints to all stocks. In the following, we use this distinction to update our portfolio sort procedure.</p>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">create_summary</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">column_name</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>value <span class="op">=</span> <span class="op">{</span><span class="op">{</span> <span class="va">column_name</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>
      mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,
      sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,
      min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,
      q05 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.05</span><span class="op">)</span>,
      q25 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.25</span><span class="op">)</span>,
      q50 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.50</span><span class="op">)</span>,
      q75 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.75</span><span class="op">)</span>,
      q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">0.95</span><span class="op">)</span>,
      max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,
      n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>
    <span class="op">)</span>
<span class="op">}</span>

<span class="va">crsp_monthly</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">exchange</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">create_summary</span><span class="op">(</span><span class="va">mktcap</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row</a></span><span class="op">(</span><span class="va">crsp_monthly</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu">create_summary</span><span class="op">(</span><span class="va">mktcap</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>exchange <span class="op">=</span> <span class="st">"Overall"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 5 x 11
##   exchange   mean     sd      min    q05    q25    q50    q75    q95    max     n
##   &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;
## 1 AMEX       283.  1298.     6.04 1.01e1 3.07e1 6.59e1   158.   535. 1.51e4   147
## 2 NASDAQ    8041. 74386.     4.65 2.73e1 1.34e2 4.85e2  2108. 19107. 2.23e6  2300
## 3 NYSE     16416. 43115.     5.35 1.54e2 9.17e2 3.34e3 12022. 74826. 4.14e5  1245
## 4 Other    10061.    NA  10061.   1.01e4 1.01e4 1.01e4 10061. 10061. 1.01e4     1
## 5 Overall  10556. 63966.     4.65 3.10e1 1.85e2 8.74e2  4196. 37059. 2.23e6  3693</code></pre>
</div>
<div id="univariate-size-portfolios-with-flexible-breakpoints" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Univariate size portfolios with flexible breakpoints<a class="anchor" aria-label="anchor" href="#univariate-size-portfolios-with-flexible-breakpoints"><i class="fas fa-link"></i></a>
</h2>
<p>In the previous chapter, we construct portfolios with a varying number of portfolios and different sorting variables. Here, we extend the framework such that we compute breakpoints on a subset of the data, for instance, based on selected listing exchanges. In published asset pricing articles, many scholars compute sorting breakpoints only on NYSE-listed stocks. These NYSE-specific breakpoints are then applied to the entire universe of stocks.</p>
<p>To replicate the NYSE-centered sorting procedure, we introduce <code>exchanges</code> as an argument in our <code>assign_portfolio()</code> function. The exchange-specific argument then enters in the filter <code>filter(grepl(exchanges, exchange))</code>. The function <code><a href="https://rdrr.io/r/base/grep.html">grepl()</a></code> is part of a family of functions on <em>regular expressions</em>, which provide various functionalities to work and manipulate character strings. Here, we replace the character string stored in the column <code>exchange</code> with a binary variable that indicates if the string matches the pattern specified in the argument <code>exchanges</code>. For example, if <code>exchanges = 'NYSE'</code> is specified, only stocks from NYSE are used to compute the breakpoints. Alternatively, you could specify <code>exchanges = 'NYSE|NASDAQ|AMEX'</code>, which keeps all stocks listed on either of these exchanges. Overall, regular expressions are a powerful tool, and we only touch on a specific case here.</p>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">assign_portfolio</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_portfolios</span>,
                             <span class="va">exchanges</span>,
                             <span class="va">data</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">breakpoints</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="va">exchanges</span>, <span class="va">exchange</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>breakpoint <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span>
      <span class="va">mktcap_lag</span>,
      probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n_portfolios</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>,
      na.rm <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">breakpoint</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span>

  <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>portfolio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/findInterval.html">findInterval</a></span><span class="op">(</span><span class="va">mktcap_lag</span>, <span class="va">breakpoints</span>, all.inside <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">portfolio</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="weighting-schemes-for-portfolios" class="section level2" number="5.4">
<h2>
<span class="header-section-number">5.4</span> Weighting schemes for portfolios<a class="anchor" aria-label="anchor" href="#weighting-schemes-for-portfolios"><i class="fas fa-link"></i></a>
</h2>
<p>Apart from computing breakpoints on different samples, researchers often use different portfolio weighting schemes. So far, we weighted each portfolio constituent by its relative market equity of the previous period. This protocol is called <em>value-weighting</em>. The alternative protocol is <em>equal-weighting</em>, which assigns each stock’s return the same weight, i.e., a simple average of the constituents’ returns. Notice that equal-weighting is difficult in practice as the portfolio manager needs to rebalance the portfolio monthly while value-weighting is a truly passive investment.</p>
<p>We implement the two weighting schemes in the function <code>compute_portfolio_returns()</code> that takes a logical argument to weight the returns by firm value. The statement <code>if_else(value_weighted, weighted.mean(ret_excess, mktcap_lag), mean(ret_excess))</code> generates value-weighted returns if <code>value_weighted = TRUE</code>. Additionally, the long-short portfolio is long in the smallest firms and short in the largest firms, consistent with research showing that small firms outperform their larger counterparts. Apart from these two changes, the function is similar to the procedure in the previous chapter.</p>
<div class="sourceCode" id="cb159"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">compute_portfolio_returns</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_portfolios</span> <span class="op">=</span> <span class="fl">10</span>,
                                      <span class="va">exchanges</span> <span class="op">=</span> <span class="st">"NYSE|NASDAQ|AMEX"</span>,
                                      <span class="va">value_weighted</span> <span class="op">=</span> <span class="cn">TRUE</span>,
                                      <span class="va">data</span> <span class="op">=</span> <span class="va">crsp_monthly</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>portfolio <span class="op">=</span> <span class="fu">assign_portfolio</span><span class="op">(</span>
      n_portfolios <span class="op">=</span> <span class="va">n_portfolios</span>,
      exchanges <span class="op">=</span> <span class="va">exchanges</span>,
      data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">cur_data</a></span><span class="op">(</span><span class="op">)</span>
    <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span>, <span class="va">portfolio</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
      ret <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">value_weighted</span>, <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">ret_excess</span>, <span class="va">mktcap_lag</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ret_excess</span><span class="op">)</span><span class="op">)</span>,
      .groups <span class="op">=</span> <span class="st">"drop_last"</span>
    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>size_premium <span class="op">=</span> <span class="va">ret</span><span class="op">[</span><span class="va">portfolio</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">portfolio</span><span class="op">)</span><span class="op">]</span> <span class="op">-</span> <span class="va">ret</span><span class="op">[</span><span class="va">portfolio</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">portfolio</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>size_premium <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">size_premium</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>To see how the function <code>compute_portfolio_returns()</code> works, we consider a simple median breakpoint example with value-weighted returns. We are interested in the effect of restricting listing exchanges on the estimation of the size premium. In the first function call, we compute returns based on breakpoints from all listing exchanges. Then, we computed returns based on breakpoints from NYSE-listed stocks.</p>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ret_all</span> <span class="op">&lt;-</span> <span class="fu">compute_portfolio_returns</span><span class="op">(</span>
  n_portfolios <span class="op">=</span> <span class="fl">2</span>,
  exchanges <span class="op">=</span> <span class="st">"NYSE|NASDAQ|AMEX"</span>,
  value_weighted <span class="op">=</span> <span class="cn">TRUE</span>,
  data <span class="op">=</span> <span class="va">crsp_monthly</span>
<span class="op">)</span>

<span class="va">ret_nyse</span> <span class="op">&lt;-</span> <span class="fu">compute_portfolio_returns</span><span class="op">(</span>
  n_portfolios <span class="op">=</span> <span class="fl">2</span>,
  exchanges <span class="op">=</span> <span class="st">"NYSE"</span>,
  value_weighted <span class="op">=</span> <span class="cn">TRUE</span>,
  data <span class="op">=</span> <span class="va">crsp_monthly</span>
<span class="op">)</span>

<span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Exchanges <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"all"</span>, <span class="st">"NYSE"</span><span class="op">)</span>, Premium <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ret_all</span>, <span class="va">ret_nyse</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##   Exchanges Premium
##   &lt;chr&gt;       &lt;dbl&gt;
## 1 all         0.110
## 2 NYSE        0.180</code></pre>
<p>The table shows that the size premium is more than 60% larger if we consider only stocks from NYSE to form the breakpoint each month. The NYSE-specific breakpoints are larger, and there are more than 50% of the stocks in the entire universe in the resulting small portfolio because NYSE firms are larger on average. The impact of this choice is not negligible.</p>
</div>
<div id="p-hacking-and-non-standard-errors" class="section level2" number="5.5">
<h2>
<span class="header-section-number">5.5</span> P-hacking and non-standard errors<a class="anchor" aria-label="anchor" href="#p-hacking-and-non-standard-errors"><i class="fas fa-link"></i></a>
</h2>
<p>Since the choice of the exchange has a significant impact, the next step is to investigate the effect of other data processing decisions researchers have to make along the way. In particular, any portfolio sort analysis has to decide at least on the number of portfolios, the listing exchanges to form breakpoints, and equal- or value-weighting. Further, one may exclude firms that are active in the finance industry or restrict the analysis to some parts of the time series. All of the variations of these choices that we discuss here are part of scholarly articles published in the top finance journals.
The intention of this application is to show that the different ways to form portfolios result in different estimated size premia. Despite the effects of this multitude of choices, there is no correct way. It should also be noted that none of the procedures is wrong, the aim is simply to illustrate the changes that can arise due to the variation in the evidence-generating process <span class="citation">(<a href="references.html#ref-Menkveld2022" role="doc-biblioref">Menkveld et al. 2021</a>)</span>.
From a malicious perspective, these modeling choices give the researcher multiple <em>chances</em> to find statistically significant results. Yet this is considered <em>p-hacking</em> which renders the statistical inference due to multiple testing invalid <span class="citation">(<a href="references.html#ref-Harvey2016" role="doc-biblioref">Harvey, Liu, and Zhu 2016</a>)</span>.</p>
<p>Nevertheless, the multitude of options creates a problem since there is no single correct way of sorting portfolios. How should a researcher convince a reader that their results do not come from a p-hacking exercise? To circumvent this dilemma, academics are encouraged to present evidence from different sorting schemes as <em>robustness tests</em> and report multiple approaches to show that a result does not depend on a single choice. Thus, the robustness of premiums is a key feature.</p>
<p>Below we conduct a series of robustness tests which could also be interpreted as a p-hacking exercise. To do so, we examine the size premium in different specifications presented in the table <code>p_hacking_setup</code>. The function <code><a href="https://tidyr.tidyverse.org/reference/expand_grid.html">expand_grid()</a></code> produces a table of all possible permutations of its arguments. Notice that we use the argument <code>data</code> to exclude financial firms and truncate the time series.</p>
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_hacking_setup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html">expand_grid</a></span><span class="op">(</span>
  n_portfolios <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>,
  exchanges <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NYSE"</span>, <span class="st">"NYSE|NASDAQ|AMEX"</span><span class="op">)</span>,
  value_weighted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>,
  data <span class="op">=</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/parse_expr.html">parse_exprs</a></span><span class="op">(</span><span class="st">'crsp_monthly; crsp_monthly %&gt;% filter(industry != "Finance");
                             crsp_monthly %&gt;% filter(month &lt; "1990-06-01");
                             crsp_monthly %&gt;% filter(month &gt;="1990-06-01")'</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">p_hacking_setup</span></code></pre></div>
<pre><code>## # A tibble: 48 x 4
##   n_portfolios exchanges value_weighted data      
##          &lt;dbl&gt; &lt;chr&gt;     &lt;lgl&gt;          &lt;list&gt;    
## 1            2 NYSE      TRUE           &lt;sym&gt;     
## 2            2 NYSE      TRUE           &lt;language&gt;
## 3            2 NYSE      TRUE           &lt;language&gt;
## 4            2 NYSE      TRUE           &lt;language&gt;
## 5            2 NYSE      FALSE          &lt;sym&gt;     
## # ... with 43 more rows</code></pre>
<p>To speed the computation up we parallelize the (many) different sorting procedures, as in Chapter 3. Finally, we report the resulting size premiums in descending order. There are indeed substantial size premia possible in our data, in particular when we use equal-weighted portfolios.</p>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fu"><a href="https://future.futureverse.org/reference/re-exports.html">availableCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p_hacking_setup</span> <span class="op">&lt;-</span> <span class="va">p_hacking_setup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>size_premium <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/furrr/man/future_map2.html">future_pmap</a></span><span class="op">(</span>
    .l <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      <span class="va">n_portfolios</span>,
      <span class="va">exchanges</span>,
      <span class="va">value_weighted</span>,
      <span class="va">data</span>
    <span class="op">)</span>,
    .f <span class="op">=</span> <span class="op">~</span> <span class="fu">compute_portfolio_returns</span><span class="op">(</span>
      n_portfolios <span class="op">=</span> <span class="va">..1</span>,
      exchanges <span class="op">=</span> <span class="va">..2</span>,
      value_weighted <span class="op">=</span> <span class="va">..3</span>,
      data <span class="op">=</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/eval_tidy.html">eval_tidy</a></span><span class="op">(</span><span class="va">..4</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span><span class="op">)</span>

<span class="va">p_hacking_results</span> <span class="op">&lt;-</span> <span class="va">p_hacking_setup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_chr</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">deparse</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">size_premium</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">data</span>, <span class="st">"crsp_monthly %&gt;% "</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">size_premium</span><span class="op">)</span><span class="op">)</span>
<span class="va">p_hacking_results</span></code></pre></div>
<pre><code>## # A tibble: 48 x 5
##   n_portfolios exchanges        value_weighted data                  size_premium
##          &lt;dbl&gt; &lt;chr&gt;            &lt;lgl&gt;          &lt;chr&gt;                        &lt;dbl&gt;
## 1           10 NYSE|NASDAQ|AMEX FALSE          "filter(month &gt;= \"1~       0.0184
## 2           10 NYSE|NASDAQ|AMEX FALSE          "filter(industry != ~       0.0180
## 3           10 NYSE|NASDAQ|AMEX FALSE          "crsp_monthly"              0.0162
## 4           10 NYSE|NASDAQ|AMEX FALSE          "filter(month &lt; \"19~       0.0139
## 5           10 NYSE|NASDAQ|AMEX TRUE           "filter(industry != ~       0.0114
## # ... with 43 more rows</code></pre>
</div>
<div id="the-size-premium-variation" class="section level2" number="5.6">
<h2>
<span class="header-section-number">5.6</span> The size-premium variation<a class="anchor" aria-label="anchor" href="#the-size-premium-variation"><i class="fas fa-link"></i></a>
</h2>
<p>We provide a graph that shows the different premiums. This plot also shows the relation to the average Fama-French SMB (small minus big) premium used in the literature which we include as a dotted vertical line.</p>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_hacking_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">size_premium</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">p_hacking_results</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span>,
    title <span class="op">=</span> <span class="st">"Size premium over different sorting choices"</span>,
    subtitle <span class="op">=</span> <span class="st">"The dotted vertical line indicates the average Fama-French SMB permium"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">factors_ff_monthly</span><span class="op">$</span><span class="va">smb</span><span class="op">)</span><span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"red"</span>,
    linetype <span class="op">=</span> <span class="st">"dashed"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">percent</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="33_size_and_portfolio_building_files/figure-html/unnamed-chunk-11-1.png" width="672" style="display: block; margin: auto;"></div>
</div>
<div id="exercises-4" class="section level2" number="5.7">
<h2>
<span class="header-section-number">5.7</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-4"><i class="fas fa-link"></i></a>
</h2>
<ol style="list-style-type: decimal">
<li>We gained several insights on the size distribution above. However, we did not analyse the average size across exchanges and industries. Which exchanges/industries have the largest firms? Plot the average firm size for the three exchanges over time. What do you see?</li>
<li>We compute breakpoints but do not take a look at them in the exposition above. This might cover potential data errors. Plot the breakpoints for ten size portfolios over time. Then, take the difference between the two extreme portfolios and plot it. Describe your results.</li>
<li>The returns that we analyse above do not account for differences in the exposure to market risk, i.e., the CAPM beta. Change the function <code>compute_portfolio_returns()</code> to output the CAPM alpha or beta instead of the average excess return.</li>
<li>While you saw the spread in returns from the p-hacking exercise, we did not show which choices led to the largest effects. Find a way to investigate which choice variable has the largest impact on the estimated size premium.</li>
<li>We computed several size premiums, but they do not follow the definition of <span class="citation"><a href="references.html#ref-Fama1993" role="doc-biblioref">Fama and French</a> (<a href="references.html#ref-Fama1993" role="doc-biblioref">1993</a>)</span>. Which of our approaches comes closest to their SMB premium?</li>
</ol>
<!-- Add final paragraph that talks about the the results and key learnigs from this chapter -->
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="univariate-portfolio-sorts.html"><span class="header-section-number">4</span> Univariate portfolio sorts</a></div>
<div class="next"><a href="value-and-bivariate-sorts.html"><span class="header-section-number">6</span> Value and bivariate sorts</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#size-sorts-and-p-hacking"><span class="header-section-number">5</span> Size sorts and p-hacking</a></li>
<li><a class="nav-link" href="#data-preparation-1"><span class="header-section-number">5.1</span> Data preparation</a></li>
<li><a class="nav-link" href="#size-distribution"><span class="header-section-number">5.2</span> Size distribution</a></li>
<li><a class="nav-link" href="#univariate-size-portfolios-with-flexible-breakpoints"><span class="header-section-number">5.3</span> Univariate size portfolios with flexible breakpoints</a></li>
<li><a class="nav-link" href="#weighting-schemes-for-portfolios"><span class="header-section-number">5.4</span> Weighting schemes for portfolios</a></li>
<li><a class="nav-link" href="#p-hacking-and-non-standard-errors"><span class="header-section-number">5.5</span> P-hacking and non-standard errors</a></li>
<li><a class="nav-link" href="#the-size-premium-variation"><span class="header-section-number">5.6</span> The size-premium variation</a></li>
<li><a class="nav-link" href="#exercises-4"><span class="header-section-number">5.7</span> Exercises</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/voigtstefan/tidy_finance/blob/main/docs/33_size_and_portfolio_building.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/voigtstefan/tidy_finance/edit/main/docs/33_size_and_portfolio_building.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Tidy Finance with R</strong>" was written by Christoph Scheuch, wikifolio Financial Technologies, Stefan Voigt, University of Copenhagen and Danish Finance Institute, Patrick Weiss, Vienna University of Economics and Business. It was last built on 2022-02-22.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
