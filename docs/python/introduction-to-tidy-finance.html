<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Tidy Finance - Introduction to Tidy Finance</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../python/accessing-and-managing-financial-data.html" rel="next">
<link href="../python/index.html" rel="prev">
<link href="../images/favicon.png" rel="icon" type="image/png">
<script src="../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-DH3KZSMJ5W"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-DH3KZSMJ5W', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"interstitial",
  "consent_type":"express",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  });
});
</script> 
  
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styling/styles.css">
<meta property="og:title" content="Tidy Finance - Introduction to Tidy Finance">
<meta property="og:description" content="">
<meta property="og:image" content="https://www.tidy-finance.org/python/introduction-to-tidy-finance_files/figure-html/fig-100-output-1.png">
<meta property="og:site-name" content="Tidy Finance">
<meta property="og:image:height" content="960">
<meta property="og:image:width" content="1280">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../images/logo-website-white.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Tidy Finance</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../r/index.html" rel="" target="">
 <span class="menu-text">R</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../python/index.html" rel="" target="" aria-current="page">
 <span class="menu-text">Python</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../contribute.html" rel="" target="">
 <span class="menu-text">Contribute</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../support.html" rel="" target="">
 <span class="menu-text">Support</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../blog.xml" rel="" target=""><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../python/introduction-to-tidy-finance.html">Getting Started</a></li><li class="breadcrumb-item"><a href="../python/introduction-to-tidy-finance.html">Introduction to Tidy Finance</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Tidy Finance with Python</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Getting Started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/introduction-to-tidy-finance.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Introduction to Tidy Finance</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Financial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/accessing-and-managing-financial-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Accessing and Managing Financial Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/wrds-crsp-and-compustat.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">WRDS, CRSP, and Compustat</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Asset Pricing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/univariate-portfolio-sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Univariate Portfolio Sorts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/size-sorts-and-p-hacking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Size Sorts and p-Hacking</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/value-and-bivariate-sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Value and Bivariate Sorts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/replicating-fama-and-french-factors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Replicating Fama and French Factors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/fama-macbeth-regressions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fama-MacBeth Regressions</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#working-with-stock-market-data" id="toc-working-with-stock-market-data" class="nav-link active" data-scroll-target="#working-with-stock-market-data">Working with Stock Market Data</a></li>
  <li><a href="#scaling-up-the-analysis" id="toc-scaling-up-the-analysis" class="nav-link" data-scroll-target="#scaling-up-the-analysis">Scaling Up the Analysis</a></li>
  <li><a href="#other-forms-of-data-aggregation" id="toc-other-forms-of-data-aggregation" class="nav-link" data-scroll-target="#other-forms-of-data-aggregation">Other Forms of Data Aggregation</a></li>
  <li><a href="#portfolio-choice-problems" id="toc-portfolio-choice-problems" class="nav-link" data-scroll-target="#portfolio-choice-problems">Portfolio Choice Problems</a></li>
  <li><a href="#the-efficient-frontier" id="toc-the-efficient-frontier" class="nav-link" data-scroll-target="#the-efficient-frontier">The Efficient Frontier</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/tidy-finance/website/edit/main/python/introduction-to-tidy-finance.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/tidy-finance/website/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Introduction to Tidy Finance</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You are reading the work-in-progress edition of <strong>Tidy Finance with Python</strong>. Code chunks and text might change over the next couple of months. We are always looking for feedback via <a href="mailto:contact@tidy-finance.org">contact@tidy-finance.org</a>. Meanwhile, you can find the complete R version <a href="../r/index.html">here</a>.</p>
</div>
</div>
<p>The main aim of this chapter is to familiarize yourself with ´pandas´ and ´numpy´, the main workhorses for data analysis in Python. We start by downloading and visualizing stock data from Yahoo!Finance. Then we move to a simple portfolio choice problem and construct the efficient frontier. These examples introduce you to our approach of <em>Tidy Finance</em>.</p>
<section id="working-with-stock-market-data" class="level2">
<h2 class="anchored" data-anchor-id="working-with-stock-market-data">Working with Stock Market Data</h2>
<p>At the start of each session, we load the required packages. Throughout the entire book, we always use <code>pandas</code> and <code>numpy</code> to perform a number of data manipulations. In this chapter, we also load the convenient <code>yfinance</code> package to download price data.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We first download daily prices for one stock symbol, e.g., the Apple stock, <em>AAPL</em>, directly from the data provider Yahoo!Finance. To download the data, you can use the function <code>yf.download()</code>. </p>
<div class="cell" data-cache="true" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>prices <span class="op">=</span> (yf.download(tickers<span class="op">=</span><span class="st">"AAPL"</span>, </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                      start<span class="op">=</span><span class="st">"2000-01-01"</span>, </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                      end<span class="op">=</span><span class="st">"2021-12-31"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  .reset_index()</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  .assign(symbol <span class="op">=</span> <span class="st">"AAPL"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  .rename(columns <span class="op">=</span> {<span class="st">"Date"</span>: <span class="st">"date"</span>, </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Open"</span>: <span class="st">"open"</span>, </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"High"</span>: <span class="st">"high"</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Low"</span>: <span class="st">"low"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Close"</span>: <span class="st">"close"</span>, </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Adj Close"</span>: <span class="st">"adjusted"</span>, </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Volume"</span>: <span class="st">"volume"</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>prices.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[*********************100%***********************]  1 of 1 completed</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">open</th>
<th data-quarto-table-cell-role="th">high</th>
<th data-quarto-table-cell-role="th">low</th>
<th data-quarto-table-cell-role="th">close</th>
<th data-quarto-table-cell-role="th">adjusted</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">symbol</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2000-01-03</td>
<td>0.936384</td>
<td>1.004464</td>
<td>0.907924</td>
<td>0.999442</td>
<td>0.849469</td>
<td>535796800</td>
<td>AAPL</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2000-01-04</td>
<td>0.966518</td>
<td>0.987723</td>
<td>0.903460</td>
<td>0.915179</td>
<td>0.777850</td>
<td>512377600</td>
<td>AAPL</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2000-01-05</td>
<td>0.926339</td>
<td>0.987165</td>
<td>0.919643</td>
<td>0.928571</td>
<td>0.789232</td>
<td>778321600</td>
<td>AAPL</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2000-01-06</td>
<td>0.947545</td>
<td>0.955357</td>
<td>0.848214</td>
<td>0.848214</td>
<td>0.720933</td>
<td>767972800</td>
<td>AAPL</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2000-01-07</td>
<td>0.861607</td>
<td>0.901786</td>
<td>0.852679</td>
<td>0.888393</td>
<td>0.755083</td>
<td>460734400</td>
<td>AAPL</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p> <code>yf.download()</code> downloads stock market data from Yahoo!Finance if you do not specify another data source. The above code chunk returns a data frame with eight quite self-explanatory columns: <code>date</code>, the market prices at the <code>open</code>, <code>high</code>, <code>low</code>, and <code>close</code>, the <code>adjusted</code> price in USD, the daily <code>volume</code> (in the number of traded shares), and the <code>symbol</code>. The adjusted prices are corrected for anything that might affect the stock price after the market closes, e.g., stock splits and dividends. These actions affect the quoted prices, but they have no direct impact on the investors who hold the stock. Therefore, we often rely on adjusted prices when it comes to analyzing the returns an investor would have earned by holding the stock continuously.</p>
<p>Next, we use the <code>plotnine</code> package to visualize the time series of adjusted prices in <a href="#fig-100">Figure&nbsp;1</a> . This package takes care of visualization tasks based on the principles of the grammar of graphics <span class="citation" data-cites="Wilkinson2012">(<a href="#ref-Wilkinson2012" role="doc-biblioref">Wilkinson 2012</a>)</span>.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>prices_figure <span class="op">=</span> (ggplot(prices, aes(y<span class="op">=</span><span class="st">"adjusted"</span>, </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                                    x<span class="op">=</span><span class="st">"date"</span>))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> geom_line()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> labs(x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Apple stock prices between beginning of 2000 and end of 2021"</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>prices_figure.draw()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div id="fig-100" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="introduction-to-tidy-finance_files/figure-html/fig-100-output-1.png" class="img-fluid figure-img" alt="Title: Apple stock prices between the beginning of 2000 and the end of 2021. The figure shows that the stock price of Apple increased dramatically from about 1 USD to around 125 USD."></p>
<figcaption class="figure-caption">Figure&nbsp;1: Prices are in USD, adjusted for dividend payments and stock splits.</figcaption>
</figure>
</div>
</div>
</div>
<p> Instead of analyzing prices, we compute daily net returns defined as <span class="math inline">\(r_t = p_t / p_{t-1} - 1\)</span>, where <span class="math inline">\(p_t\)</span> is the adjusted day <span class="math inline">\(t\)</span> price. In that context, the function <code>pct_change()</code> is helpful because it computes this percentage change.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> (prices</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  .sort_values(<span class="st">"date"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  .assign(ret <span class="op">=</span> <span class="kw">lambda</span> x: x[<span class="st">"adjusted"</span>].pct_change())</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  .get([<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"ret"</span>])</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>returns.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ret</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>AAPL</td>
<td>2000-01-03</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>AAPL</td>
<td>2000-01-04</td>
<td>-0.084310</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>AAPL</td>
<td>2000-01-05</td>
<td>0.014633</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>AAPL</td>
<td>2000-01-06</td>
<td>-0.086539</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>AAPL</td>
<td>2000-01-07</td>
<td>0.047369</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The resulting data frame contains three columns, where the last contains the daily returns (<code>ret</code>). Note that the first entry naturally contains a missing value (<code>NaN</code>) because there is no previous price. Obviously, the use of <code>pct_change()</code> would be meaningless if the time series is not ordered by ascending dates. The function <code>sort_values()</code> provides a convenient way to order observations in the correct way for our application. In case you want to order observations by descending dates, you can use the parameter <code>ascending=False</code>.</p>
<p>For the upcoming examples, we remove missing values as these would require separate treatment when computing, e.g., sample averages. In general, however, make sure you understand why <code>NA</code> values occur and carefully examine if you can simply get rid of these observations.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> returns.dropna() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we visualize the distribution of daily returns in a histogram in <a href="#fig-101">Figure&nbsp;2</a>. Additionally, we add a dashed line that indicates the 5 percent quantile of the daily returns to the histogram, which is a (crude) proxy for the worst return of the stock with a probability of at most 5 percent. The 5 percent quantile is closely connected to the (historical) value-at-risk, a risk measure commonly monitored by regulators. We refer to <span class="citation" data-cites="Tsay2010">Tsay (<a href="#ref-Tsay2010" role="doc-biblioref">2010</a>)</span> for a more thorough introduction to stylized facts of returns.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>quantile_05 <span class="op">=</span> returns[<span class="st">"ret"</span>].quantile(<span class="fl">0.05</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>returns_figure <span class="op">=</span> (ggplot(returns, aes(x<span class="op">=</span><span class="st">"ret"</span>))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> geom_histogram(bins<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> geom_vline(aes(xintercept<span class="op">=</span>quantile_05), linetype<span class="op">=</span><span class="st">"dashed"</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> labs(x<span class="op">=</span><span class="va">None</span>, y<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Distribution of daily Apple stock returns"</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> scale_x_continuous(labels<span class="op">=</span>percent_format())</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>returns_figure.draw()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div id="fig-101" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="introduction-to-tidy-finance_files/figure-html/fig-101-output-1.png" class="img-fluid figure-img" alt="Title: Distribution of daily Apple stock returns in percent. The figure shows a histogram of daily returns. The range indicates a few large negative values, while the remaining returns are distributed around 0. The vertical line indicates that the historical 5 percent quantile of daily returns was around negative 3 percent."></p>
<figcaption class="figure-caption">Figure&nbsp;2: The dotted vertical line indicates the historical 5 percent quantile.</figcaption>
</figure>
</div>
</div>
</div>
<p>Here, <code>bins = 100</code> determines the number of bins used in the illustration and hence implicitly the width of the bins. Before proceeding, make sure you understand how to use the geom <code>geom_vline()</code> to add a dashed line that indicates the 5 percent quantile of the daily returns. A typical task before proceeding with <em>any</em> data is to compute summary statistics for the main variables of interest.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>returns[<span class="st">"ret"</span>].describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>count    5534.000000
mean        0.001297
std         0.025237
min        -0.518692
25%        -0.010100
50%         0.000942
75%         0.013111
max         0.139049
Name: ret, dtype: float64</code></pre>
</div>
</div>
<p>We see that the maximum <em>daily</em> return was <code>{python} round(returns["ret"].max() * 100, 3)</code> percent. Perhaps not surprisingly, the average daily return is close to but slightly above 0. In line with the illustration above, the large losses on the day with the minimum returns indicate a strong asymmetry in the distribution of returns.<br>
You can also compute these summary statistics for each year individually by imposing <code>.groupby(returns["date"].dt.year)</code>, where the call <code>.dt.year</code> returns the year of a date variable. More specifically, the few lines of code below compute the summary statistics from above for individual groups of data defined by year. The summary statistics, therefore, allow an eyeball analysis of the time-series dynamics of the return distribution.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>returns[<span class="st">"ret"</span>].groupby(returns[<span class="st">"date"</span>].dt.year).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">25%</th>
<th data-quarto-table-cell-role="th">50%</th>
<th data-quarto-table-cell-role="th">75%</th>
<th data-quarto-table-cell-role="th">max</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000</td>
<td>251.0</td>
<td>-0.003457</td>
<td>0.054940</td>
<td>-0.518692</td>
<td>-0.034425</td>
<td>-0.001702</td>
<td>0.027153</td>
<td>0.136858</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2001</td>
<td>248.0</td>
<td>0.002329</td>
<td>0.039338</td>
<td>-0.171712</td>
<td>-0.022873</td>
<td>-0.001162</td>
<td>0.026942</td>
<td>0.128567</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2002</td>
<td>252.0</td>
<td>-0.001212</td>
<td>0.030526</td>
<td>-0.150372</td>
<td>-0.018749</td>
<td>-0.002787</td>
<td>0.017930</td>
<td>0.084558</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2003</td>
<td>252.0</td>
<td>0.001857</td>
<td>0.023360</td>
<td>-0.081421</td>
<td>-0.012068</td>
<td>0.001549</td>
<td>0.014642</td>
<td>0.113492</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2004</td>
<td>252.0</td>
<td>0.004702</td>
<td>0.025470</td>
<td>-0.055785</td>
<td>-0.009004</td>
<td>0.002835</td>
<td>0.015525</td>
<td>0.131573</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2005</td>
<td>252.0</td>
<td>0.003490</td>
<td>0.024478</td>
<td>-0.092105</td>
<td>-0.010068</td>
<td>0.003440</td>
<td>0.016910</td>
<td>0.091168</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2006</td>
<td>251.0</td>
<td>0.000949</td>
<td>0.024265</td>
<td>-0.063326</td>
<td>-0.014082</td>
<td>-0.001525</td>
<td>0.014302</td>
<td>0.118299</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2007</td>
<td>251.0</td>
<td>0.003664</td>
<td>0.023757</td>
<td>-0.070206</td>
<td>-0.008942</td>
<td>0.002557</td>
<td>0.017957</td>
<td>0.105359</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2008</td>
<td>253.0</td>
<td>-0.002646</td>
<td>0.036666</td>
<td>-0.179195</td>
<td>-0.023983</td>
<td>-0.001043</td>
<td>0.018687</td>
<td>0.139049</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2009</td>
<td>252.0</td>
<td>0.003819</td>
<td>0.021369</td>
<td>-0.050164</td>
<td>-0.008984</td>
<td>0.002112</td>
<td>0.015498</td>
<td>0.067592</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2010</td>
<td>252.0</td>
<td>0.001832</td>
<td>0.016856</td>
<td>-0.049598</td>
<td>-0.006217</td>
<td>0.002332</td>
<td>0.011379</td>
<td>0.076867</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2011</td>
<td>252.0</td>
<td>0.001040</td>
<td>0.016539</td>
<td>-0.055940</td>
<td>-0.009266</td>
<td>0.001067</td>
<td>0.011128</td>
<td>0.058888</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2012</td>
<td>250.0</td>
<td>0.001299</td>
<td>0.018566</td>
<td>-0.064357</td>
<td>-0.007969</td>
<td>0.000473</td>
<td>0.011957</td>
<td>0.088741</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2013</td>
<td>252.0</td>
<td>0.000472</td>
<td>0.017987</td>
<td>-0.123558</td>
<td>-0.008709</td>
<td>-0.000278</td>
<td>0.010901</td>
<td>0.051361</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2014</td>
<td>252.0</td>
<td>0.001447</td>
<td>0.013643</td>
<td>-0.079928</td>
<td>-0.005763</td>
<td>0.001042</td>
<td>0.009585</td>
<td>0.081982</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2015</td>
<td>252.0</td>
<td>0.000020</td>
<td>0.016843</td>
<td>-0.061163</td>
<td>-0.008595</td>
<td>-0.000630</td>
<td>0.009395</td>
<td>0.057355</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2016</td>
<td>252.0</td>
<td>0.000575</td>
<td>0.014702</td>
<td>-0.065706</td>
<td>-0.005742</td>
<td>0.000873</td>
<td>0.007724</td>
<td>0.064963</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2017</td>
<td>251.0</td>
<td>0.001637</td>
<td>0.011091</td>
<td>-0.038777</td>
<td>-0.003720</td>
<td>0.000667</td>
<td>0.006761</td>
<td>0.060981</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2018</td>
<td>251.0</td>
<td>-0.000057</td>
<td>0.018106</td>
<td>-0.066331</td>
<td>-0.008958</td>
<td>0.000524</td>
<td>0.009429</td>
<td>0.070421</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019</td>
<td>252.0</td>
<td>0.002665</td>
<td>0.016466</td>
<td>-0.099607</td>
<td>-0.004797</td>
<td>0.002753</td>
<td>0.011551</td>
<td>0.068335</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2020</td>
<td>253.0</td>
<td>0.002807</td>
<td>0.029387</td>
<td>-0.128647</td>
<td>-0.010259</td>
<td>0.001749</td>
<td>0.017396</td>
<td>0.119808</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2021</td>
<td>251.0</td>
<td>0.001325</td>
<td>0.015841</td>
<td>-0.041674</td>
<td>-0.007655</td>
<td>0.001474</td>
<td>0.012455</td>
<td>0.053851</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p></p>
</section>
<section id="scaling-up-the-analysis" class="level2">
<h2 class="anchored" data-anchor-id="scaling-up-the-analysis">Scaling Up the Analysis</h2>
<p>As a next step, we generalize the code from before such that all the computations can handle an arbitrary vector of stock symbols (e.g., all constituents of an index). Following tidy principles, it is quite easy to download the data, plot the price time series, and tabulate the summary statistics for an arbitrary number of assets.</p>
<p>This is where the magic starts: tidy data makes it extremely easy to generalize the computations from before to as many assets as you like. The following code takes any vector of symbols, e.g., <code>symbol = ["AAPL", "MMM", "BA"]</code>, and automates the download as well as the plot of the price time series. In the end, we create the table of summary statistics for an arbitrary number of assets. We perform the analysis with data from all current constituents of the <a href="https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average">Dow Jones Industrial Average index.</a> </p>
<p>We first download a table with DOW Jones constituents from an external website.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> (<span class="st">"https://www.ssga.com/us/en/institutional/etfs/library-content/"</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>       <span class="st">"products/fund-data/etfs/us/holdings-daily-us-en-dia.xlsx"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>symbols <span class="op">=</span> (pd.read_excel(url, skiprows<span class="op">=</span><span class="dv">4</span>, nrows<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  .get(<span class="st">"Ticker"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  .tolist()</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we can use <code>yf.download()</code> to download prices for all stock symbols in the above list.</p>
<div class="cell" data-cache="true" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>index_prices <span class="op">=</span> (yf.download(tickers<span class="op">=</span>symbols, </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                            start<span class="op">=</span><span class="st">"2000-01-01"</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                            end<span class="op">=</span><span class="st">"2021-12-31"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                            progress<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  .melt(ignore_index<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        var_name<span class="op">=</span>[<span class="st">"variable"</span>, <span class="st">"symbol"</span>])</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  .reset_index()</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  .pivot(index<span class="op">=</span>[<span class="st">"Date"</span>, <span class="st">"symbol"</span>], </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>         columns<span class="op">=</span><span class="st">"variable"</span>, </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>         values<span class="op">=</span><span class="st">"value"</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  .reset_index()</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  .rename(columns <span class="op">=</span> {<span class="st">"Date"</span>: <span class="st">"date"</span>, </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Open"</span>: <span class="st">"open"</span>, </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"High"</span>: <span class="st">"high"</span>, </span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Low"</span>: <span class="st">"low"</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Close"</span>: <span class="st">"close"</span>, </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Adj Close"</span>: <span class="st">"adjusted"</span>, </span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Volume"</span>: <span class="st">"volume"</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resulting data frame contains <code>{python} len(index_prices)</code> daily observations for <code>{python} len(index_prices["symbol"].unique())</code> different stock symbols. <a href="#fig-103">Figure&nbsp;3</a> illustrates the time series of downloaded <em>adjusted</em> prices for each of the constituents of the Dow Jones index. Make sure you understand every single line of code! (What are the arguments of <code>aes()</code>? Which alternative <code>geoms</code> could you use to visualize the time series? Hint: if you do not know the answers try to change the code to see what difference your intervention causes.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>index_prices_figure <span class="op">=</span> (ggplot(index_prices, </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                              aes(y<span class="op">=</span><span class="st">"adjusted"</span>, </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                                  x<span class="op">=</span><span class="st">"date"</span>, </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                                  color<span class="op">=</span><span class="st">"symbol"</span>))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> geom_line()</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> labs(x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">""</span>, color<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Stock prices of DOW index constituents"</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> theme(legend_position<span class="op">=</span><span class="st">"none"</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>index_prices_figure.draw()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div id="fig-103" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="introduction-to-tidy-finance_files/figure-html/fig-103-output-1.png" class="img-fluid figure-img" alt="Title: Stock prices of DOW index constituents. The figure shows many time series with daily prices. The general trend seems positive for most stocks in the DOW index."></p>
<figcaption class="figure-caption">Figure&nbsp;3: Prices in USD, adjusted for dividend payments and stock splits.</figcaption>
</figure>
</div>
</div>
</div>
<p>Do you notice the small differences relative to the code we used before? <code>yf.download(symbols)</code> returns a data frame for several symbols as well. All we need to do to illustrate all symbols simultaneously is to include <code>color = symbol</code> in the <code>ggplot2</code> aesthetics. In this way, we generate a separate line for each symbol. Of course, there are simply too many lines on this graph to identify the individual stocks properly, but it illustrates the point well.</p>
<p>The same holds for stock returns. Before computing the returns, we use <code>groupby("symbol")</code> such that the <code>assign()</code> command is performed for each symbol individually. The same logic also applies to the computation of summary statistics: <code>groupby("symbol")</code> is the key to aggregating the time series into symbol-specific variables of interest.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>all_returns <span class="op">=</span> (index_prices</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  .assign(ret <span class="op">=</span> <span class="kw">lambda</span> x: x.groupby(<span class="st">"symbol"</span>)[<span class="st">"adjusted"</span>].pct_change())</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  .get([<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"ret"</span>])</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  .dropna(subset<span class="op">=</span><span class="st">"ret"</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>all_returns.groupby(<span class="st">"symbol"</span>)[<span class="st">"ret"</span>].describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">25%</th>
<th data-quarto-table-cell-role="th">50%</th>
<th data-quarto-table-cell-role="th">75%</th>
<th data-quarto-table-cell-role="th">max</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">AAPL</td>
<td>5534.0</td>
<td>0.001297</td>
<td>0.025237</td>
<td>-0.518692</td>
<td>-0.010100</td>
<td>0.000941</td>
<td>0.013111</td>
<td>0.139050</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">AMGN</td>
<td>5534.0</td>
<td>0.000475</td>
<td>0.019886</td>
<td>-0.134124</td>
<td>-0.008830</td>
<td>0.000077</td>
<td>0.009601</td>
<td>0.151021</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">AXP</td>
<td>5534.0</td>
<td>0.000547</td>
<td>0.022962</td>
<td>-0.175950</td>
<td>-0.008379</td>
<td>0.000396</td>
<td>0.009700</td>
<td>0.218822</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">BA</td>
<td>5534.0</td>
<td>0.000614</td>
<td>0.021992</td>
<td>-0.238484</td>
<td>-0.009625</td>
<td>0.000574</td>
<td>0.010878</td>
<td>0.243186</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CAT</td>
<td>5534.0</td>
<td>0.000699</td>
<td>0.020360</td>
<td>-0.145175</td>
<td>-0.009527</td>
<td>0.000487</td>
<td>0.010996</td>
<td>0.147230</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CRM</td>
<td>4412.0</td>
<td>0.001283</td>
<td>0.026786</td>
<td>-0.271482</td>
<td>-0.011358</td>
<td>0.000566</td>
<td>0.013425</td>
<td>0.260449</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CSCO</td>
<td>5534.0</td>
<td>0.000370</td>
<td>0.023922</td>
<td>-0.162107</td>
<td>-0.009009</td>
<td>0.000490</td>
<td>0.010301</td>
<td>0.243884</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CVX</td>
<td>5534.0</td>
<td>0.000486</td>
<td>0.017494</td>
<td>-0.221248</td>
<td>-0.007891</td>
<td>0.000753</td>
<td>0.008919</td>
<td>0.227407</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">DIS</td>
<td>5534.0</td>
<td>0.000531</td>
<td>0.019293</td>
<td>-0.183630</td>
<td>-0.008368</td>
<td>0.000366</td>
<td>0.008986</td>
<td>0.159722</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">DOW</td>
<td>702.0</td>
<td>0.000799</td>
<td>0.028071</td>
<td>-0.216577</td>
<td>-0.012512</td>
<td>0.000571</td>
<td>0.015287</td>
<td>0.209091</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">GS</td>
<td>5534.0</td>
<td>0.000584</td>
<td>0.023326</td>
<td>-0.189596</td>
<td>-0.010114</td>
<td>0.000350</td>
<td>0.011161</td>
<td>0.264678</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">HD</td>
<td>5534.0</td>
<td>0.000601</td>
<td>0.019350</td>
<td>-0.287356</td>
<td>-0.008041</td>
<td>0.000544</td>
<td>0.009190</td>
<td>0.140665</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">HON</td>
<td>5534.0</td>
<td>0.000523</td>
<td>0.019516</td>
<td>-0.173669</td>
<td>-0.008009</td>
<td>0.000560</td>
<td>0.008897</td>
<td>0.282230</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">IBM</td>
<td>5534.0</td>
<td>0.000262</td>
<td>0.016600</td>
<td>-0.155420</td>
<td>-0.007070</td>
<td>0.000287</td>
<td>0.007666</td>
<td>0.120233</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">INTC</td>
<td>5534.0</td>
<td>0.000400</td>
<td>0.023587</td>
<td>-0.220330</td>
<td>-0.010305</td>
<td>0.000466</td>
<td>0.011279</td>
<td>0.201229</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">JNJ</td>
<td>5534.0</td>
<td>0.000415</td>
<td>0.012260</td>
<td>-0.158456</td>
<td>-0.005089</td>
<td>0.000309</td>
<td>0.006093</td>
<td>0.122292</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">JPM</td>
<td>5534.0</td>
<td>0.000625</td>
<td>0.024423</td>
<td>-0.207275</td>
<td>-0.008938</td>
<td>0.000232</td>
<td>0.009873</td>
<td>0.250968</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">KO</td>
<td>5534.0</td>
<td>0.000329</td>
<td>0.013261</td>
<td>-0.100609</td>
<td>-0.005468</td>
<td>0.000431</td>
<td>0.006345</td>
<td>0.138796</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">MCD</td>
<td>5534.0</td>
<td>0.000553</td>
<td>0.014825</td>
<td>-0.158754</td>
<td>-0.006189</td>
<td>0.000742</td>
<td>0.007322</td>
<td>0.181255</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">MMM</td>
<td>5534.0</td>
<td>0.000452</td>
<td>0.014939</td>
<td>-0.129450</td>
<td>-0.006285</td>
<td>0.000540</td>
<td>0.007535</td>
<td>0.125986</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">MRK</td>
<td>5534.0</td>
<td>0.000325</td>
<td>0.016950</td>
<td>-0.267806</td>
<td>-0.007439</td>
<td>0.000245</td>
<td>0.008444</td>
<td>0.130329</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">MSFT</td>
<td>5534.0</td>
<td>0.000587</td>
<td>0.019251</td>
<td>-0.155978</td>
<td>-0.008024</td>
<td>0.000359</td>
<td>0.009221</td>
<td>0.195652</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">NKE</td>
<td>5534.0</td>
<td>0.000824</td>
<td>0.019003</td>
<td>-0.198127</td>
<td>-0.007891</td>
<td>0.000592</td>
<td>0.009230</td>
<td>0.155314</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PG</td>
<td>5534.0</td>
<td>0.000398</td>
<td>0.013377</td>
<td>-0.302358</td>
<td>-0.005203</td>
<td>0.000371</td>
<td>0.006140</td>
<td>0.120090</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">TRV</td>
<td>5534.0</td>
<td>0.000554</td>
<td>0.018488</td>
<td>-0.208004</td>
<td>-0.007306</td>
<td>0.000630</td>
<td>0.008269</td>
<td>0.255555</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">UNH</td>
<td>5534.0</td>
<td>0.001012</td>
<td>0.019964</td>
<td>-0.186362</td>
<td>-0.008072</td>
<td>0.000810</td>
<td>0.009909</td>
<td>0.347550</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">V</td>
<td>3471.0</td>
<td>0.000995</td>
<td>0.018948</td>
<td>-0.136434</td>
<td>-0.007636</td>
<td>0.001223</td>
<td>0.009523</td>
<td>0.149974</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">VZ</td>
<td>5534.0</td>
<td>0.000287</td>
<td>0.015149</td>
<td>-0.118462</td>
<td>-0.007086</td>
<td>0.000212</td>
<td>0.007449</td>
<td>0.146324</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">WBA</td>
<td>5534.0</td>
<td>0.000340</td>
<td>0.018121</td>
<td>-0.149873</td>
<td>-0.008526</td>
<td>0.000000</td>
<td>0.009254</td>
<td>0.166355</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">WMT</td>
<td>5534.0</td>
<td>0.000321</td>
<td>0.014925</td>
<td>-0.101833</td>
<td>-0.006663</td>
<td>0.000276</td>
<td>0.006919</td>
<td>0.117085</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p></p>
</section>
<section id="other-forms-of-data-aggregation" class="level2">
<h2 class="anchored" data-anchor-id="other-forms-of-data-aggregation">Other Forms of Data Aggregation</h2>
<p>Of course, aggregation across variables other than <code>symbol</code> can also make sense. For instance, suppose you are interested in answering the question: are days with high aggregate trading volume likely followed by days with high aggregate trading volume? To provide some initial analysis on this question, we take the downloaded data and compute aggregate daily trading volume for all Dow Jones constituents in USD. Recall that the column <code>volume</code> is denoted in the number of traded shares. Thus, we multiply the trading volume with the daily adjusted closing price to get a proxy for the aggregate trading volume in USD. Scaling by <code>1e9</code> (Python can handle scientific notation) denotes daily trading volume in billion USD.</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>trading_volume <span class="op">=</span> (index_prices</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  .assign(trading_volume <span class="op">=</span> <span class="kw">lambda</span> x: (x[<span class="st">"volume"</span>] <span class="op">*</span> x[<span class="st">"adjusted"</span>]) <span class="op">/</span> <span class="fl">1e9</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  .groupby(<span class="st">"date"</span>)[<span class="st">"trading_volume"</span>]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  .<span class="bu">sum</span>()</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  .reset_index()</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  .assign(trading_volume_lag <span class="op">=</span> <span class="kw">lambda</span> x: x[<span class="st">"trading_volume"</span>].shift())</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>trading_volume_figure <span class="op">=</span> (ggplot(trading_volume, </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>                                aes(x<span class="op">=</span><span class="st">"date"</span>, </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>                                    y<span class="op">=</span><span class="st">"trading_volume"</span>))</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> geom_line()</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> labs(x<span class="op">=</span><span class="st">""</span>, </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Aggregate daily trading volume of "</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>              <span class="st">"DOW index constituents in billion USD"</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>trading_volume_figure.draw()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div id="fig-104" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="introduction-to-tidy-finance_files/figure-html/fig-104-output-1.png" class="img-fluid figure-img" alt="Title: Aggregate daily trading volume. The figure shows a volatile time series of daily trading volume, ranging from 15 in 2000 to 20.5 in 2021, with a maximum of more than 100."></p>
<figcaption class="figure-caption">Figure&nbsp;4: Total daily trading volume in billion USD.</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#fig-104">Figure&nbsp;4</a> indicates a clear upward trend in aggregated daily trading volume. In particular, since the outbreak of the COVID-19 pandemic, markets have processed substantial trading volumes, as analyzed, for instance, by <span class="citation" data-cites="Goldstein2021">Goldstein, Koijen, and Mueller (<a href="#ref-Goldstein2021" role="doc-biblioref">2021</a>)</span>. One way to illustrate the persistence of trading volume would be to plot volume on day <span class="math inline">\(t\)</span> against volume on day <span class="math inline">\(t-1\)</span> as in the example below. In <a href="#fig-105">Figure&nbsp;5</a>, we add a dotted 45°-line to indicate a hypothetical one-to-one relation by <code>geom_abline()</code>, addressing potential differences in the axes’ scales.</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>trading_volume_figure <span class="op">=</span> (ggplot(trading_volume, </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                                aes(x<span class="op">=</span><span class="st">"trading_volume_lag"</span>, </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                                    y<span class="op">=</span><span class="st">"trading_volume"</span>))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> geom_point()</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> geom_abline(aes(intercept<span class="op">=</span><span class="dv">0</span>, slope<span class="op">=</span><span class="dv">1</span>), </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>               linetype<span class="op">=</span><span class="st">"dashed"</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> labs(x<span class="op">=</span><span class="st">"Previous day aggregate trading volume"</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Aggregate trading volume"</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Persistence in daily trading volume of DOW constituents "</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>              <span class="st">"in billion USD"</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>trading_volume_figure.draw()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div id="fig-105" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="introduction-to-tidy-finance_files/figure-html/fig-105-output-1.png" class="img-fluid figure-img" alt="Title: Persistence in daily trading volume of DOW index constituents. The figure shows a scatterplot where aggregate trading volume and previous-day aggregate trading volume neatly line up along a 45-degree line."></p>
<figcaption class="figure-caption">Figure&nbsp;5: Total daily trading volume in billion USD.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="portfolio-choice-problems" class="level2">
<h2 class="anchored" data-anchor-id="portfolio-choice-problems">Portfolio Choice Problems</h2>
<p>In the previous part, we show how to download stock market data and inspect it with graphs and summary statistics. Now, we move to a typical question in Finance: how to allocate wealth across different assets optimally. The standard framework for optimal portfolio selection considers investors that prefer higher future returns but dislike future return volatility (defined as the square root of the return variance): the <em>mean-variance investor</em> <span class="citation" data-cites="Markowitz1952">(<a href="#ref-Markowitz1952" role="doc-biblioref">Markowitz 1952</a>)</span>.</p>
<p> An essential tool to evaluate portfolios in the mean-variance context is the <em>efficient frontier</em>, the set of portfolios which satisfies the condition that no other portfolio exists with a higher expected return but with the same volatility (the square root of the variance, i.e., the risk), see, e.g., <span class="citation" data-cites="Merton1972">Merton (<a href="#ref-Merton1972" role="doc-biblioref">1972</a>)</span>. We compute and visualize the efficient frontier for several stocks. First, we extract each asset’s <em>monthly</em> returns. In order to keep things simple, we work with a balanced panel and exclude DOW constituents for which we do not observe a price on every single trading day since the year 2000.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>prices <span class="op">=</span> (index_prices</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  .groupby(<span class="st">"symbol"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  .<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.assign(counts <span class="op">=</span> x[<span class="st">"adjusted"</span>].dropna().count()))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  .query(<span class="st">"counts == counts.max()"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we transform the returns from a tidy data frame into a <span class="math inline">\((T \times N)\)</span> matrix with one column for each of the <span class="math inline">\(N\)</span> symbols and one row for each of the <span class="math inline">\(T\)</span> trading days to compute the sample average return vector <span class="math display">\[\hat\mu = \frac{1}{T}\sum\limits_{t=1}^T r_t\]</span> where <span class="math inline">\(r_t\)</span> is the <span class="math inline">\(N\)</span> vector of returns on date <span class="math inline">\(t\)</span> and the sample covariance matrix <span class="math display">\[\hat\Sigma = \frac{1}{T-1}\sum\limits_{t=1}^T (r_t - \hat\mu)(r_t - \hat\mu)'.\]</span> We achieve this by using <code>pivot()</code> with the new column names from the column <code>symbol</code> and setting the values to <code>adjusted</code>. We compute the vector of sample average returns and the sample variance-covariance matrix, which we consider as proxies for the parameters of the distribution of future stock returns. Thus, for simplicity, we refer to <span class="math inline">\(\Sigma\)</span> and <span class="math inline">\(\mu\)</span> instead of explicitly highlighting that the sample moments are estimates. In later chapters, we discuss the issues that arise once we take estimation uncertainty into account.</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>returns_matrix <span class="op">=</span> (prices</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  .pivot(columns<span class="op">=</span><span class="st">"symbol"</span>, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>         values<span class="op">=</span><span class="st">"adjusted"</span>, </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>         index<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  .resample(<span class="st">"m"</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  .last()</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  .pct_change()</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  .dropna()</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>length_year <span class="op">=</span> <span class="dv">12</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>mu <span class="op">=</span> np.array(returns_matrix.mean()).T <span class="op">*</span> length_year</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>sigma <span class="op">=</span> np.array(returns_matrix.cov()) <span class="op">*</span> length_year</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we compute the minimum variance portfolio weights <span class="math inline">\(\omega_\text{mvp}\)</span> as well as the expected portfolio return <span class="math inline">\(\omega_\text{mvp}'\mu\)</span> and volatility <span class="math inline">\(\sqrt{\omega_\text{mvp}'\Sigma\omega_\text{mvp}}\)</span> of this portfolio. Recall that the minimum variance portfolio is the vector of portfolio weights that are the solution to <span class="math display">\[\omega_\text{mvp} = \arg\min \omega'\Sigma \omega \text{ s.t. } \sum\limits_{i=1}^N\omega_i = 1.\]</span> The constraint that weights sum up to one simply implies that all funds are distributed across the available asset universe, i.e., there is no possibility to retain cash. It is easy to show analytically that <span class="math inline">\(\omega_\text{mvp} = \frac{\Sigma^{-1}\iota}{\iota'\Sigma^{-1}\iota}\)</span>, where <span class="math inline">\(\iota\)</span> is a vector of ones and <span class="math inline">\(\Sigma^{-1}\)</span> is the inverse of <span class="math inline">\(\Sigma\)</span>.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> returns_matrix.shape[<span class="dv">1</span>]</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>iota <span class="op">=</span> np.ones(N)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>sigma_inv <span class="op">=</span> np.linalg.inv(sigma) </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>mvp_weights <span class="op">=</span> sigma_inv <span class="op">@</span> iota</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>mvp_weights <span class="op">/=</span> mvp_weights.<span class="bu">sum</span>()</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>mvp_return <span class="op">=</span> (mu.T <span class="op">@</span> mvp_weights)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>mvp_volatility <span class="op">=</span> np.sqrt(mvp_weights.T <span class="op">@</span> sigma <span class="op">@</span> mvp_weights)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>mvp_moments <span class="op">=</span> pd.DataFrame([mvp_return, mvp_volatility],</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>                          index<span class="op">=</span>[<span class="st">"average_ret"</span>, <span class="st">"volatility"</span>]).T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The command <code>np.linalg.inv()</code> returns the solution of a system of equations <span class="math inline">\(Ax = b\)</span>. If <code>b</code> is not provided, as in the example above, it defaults to the identity matrix such that <code>np.linalg.inv(sigma)</code> delivers <span class="math inline">\(\Sigma^{-1}\)</span> (if a unique solution exists).<br>
Note that the <em>monthly</em> volatility of the minimum variance portfolio is of the same order of magnitude as the <em>daily</em> standard deviation of the individual components. Thus, the diversification benefits in terms of risk reduction are tremendous!</p>
<p>Next, we set out to find the weights for a portfolio that achieves, as an example, three times the expected return of the minimum variance portfolio. However, mean-variance investors are not interested in any portfolio that achieves the required return but rather in the efficient portfolio, i.e., the portfolio with the lowest standard deviation. If you wonder where the solution <span class="math inline">\(\omega_\text{eff}\)</span> comes from: The efficient portfolio is chosen by an investor who aims to achieve minimum variance <em>given a minimum acceptable expected return</em> <span class="math inline">\(\bar{\mu}\)</span>. Hence, their objective function is to choose <span class="math inline">\(\omega_\text{eff}\)</span> as the solution to <span class="math display">\[\omega_\text{eff}(\bar{\mu}) = \arg\min \omega'\Sigma \omega \text{ s.t. } \omega'\iota = 1 \text{ and } \omega'\mu \geq \bar{\mu}.\]</span></p>
<p>The code below implements the analytic solution to this optimization problem for a benchmark return <span class="math inline">\(\bar\mu\)</span>, which we set to 3 times the expected return of the minimum variance portfolio. We encourage you to verify that it is correct.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>benchmark_multiple <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>mu_bar <span class="op">=</span> benchmark_multiple <span class="op">*</span> mvp_return</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>C <span class="op">=</span> iota.T <span class="op">@</span> sigma_inv <span class="op">@</span> iota</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>D <span class="op">=</span> iota.T <span class="op">@</span> sigma_inv <span class="op">@</span> mu</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>E <span class="op">=</span> mu.T <span class="op">@</span> sigma_inv <span class="op">@</span> mu</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>lambda_tilde <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (mu_bar <span class="op">-</span> D <span class="op">/</span> C) <span class="op">/</span> (E <span class="op">-</span> D <span class="op">**</span> <span class="dv">2</span> <span class="op">/</span> C)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>efp_weights <span class="op">=</span> (mvp_weights <span class="op">+</span> lambda_tilde <span class="op">/</span> <span class="dv">2</span> <span class="op">*</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>               (sigma_inv <span class="op">@</span> mu <span class="op">-</span> D <span class="op">*</span> mvp_weights))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-efficient-frontier" class="level2">
<h2 class="anchored" data-anchor-id="the-efficient-frontier">The Efficient Frontier</h2>
<p> The mutual fund separation theorem states that as soon as we have two efficient portfolios (such as the minimum variance portfolio <span class="math inline">\(\omega_\text{mvp}\)</span> and the efficient portfolio for a higher required level of expected returns <span class="math inline">\(\omega_\text{eff}(\bar{\mu})\)</span>, we can characterize the entire efficient frontier by combining these two portfolios. That is, any linear combination of the two portfolio weights will again represent an efficient portfolio. The code below implements the construction of the <em>efficient frontier</em>, which characterizes the highest expected return achievable at each level of risk. To understand the code better, make sure to familiarize yourself with the inner workings of the <code>for</code> loop.</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> np.arange(<span class="op">-</span><span class="fl">0.4</span>, <span class="fl">2.0</span>, <span class="fl">0.01</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> pd.DataFrame(columns<span class="op">=</span>[<span class="st">"mu"</span>, <span class="st">"sd"</span>], index<span class="op">=</span>a).astype(<span class="bu">float</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> a:</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> i) <span class="op">*</span> mvp_weights <span class="op">+</span> i <span class="op">*</span> efp_weights</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    res.loc[i, <span class="st">"mu"</span>] <span class="op">=</span> (w.T <span class="op">@</span> mu)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    res.loc[i, <span class="st">"sd"</span>] <span class="op">=</span> np.sqrt(w.T <span class="op">@</span> sigma <span class="op">@</span> w)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code above proceeds in two steps: First, we compute a vector of combination weights <span class="math inline">\(a\)</span> and then we evaluate the resulting linear combination with <span class="math inline">\(a\in\mathbb{python}\)</span>:<br>
<span class="math display">\[\omega^* = a\omega_\text{eff}(\bar\mu) + (1-a)\omega_\text{mvp} = \omega_\text{mvp} + \frac{\lambda^*}{2}\left(\Sigma^{-1}\mu -\frac{D}{C}\Sigma^{-1}\iota \right)\]</span> with <span class="math inline">\(\lambda^* = 2\frac{a\bar\mu + (1-a)\tilde\mu - D/C}{E-D^2/C}\)</span> where <span class="math inline">\(C = \iota'\Sigma^{-1}\iota\)</span>, <span class="math inline">\(D=\iota'\Sigma^{-1}\mu\)</span>, and <span class="math inline">\(E=\mu'\Sigma^{-1}\mu\)</span>. Finally, it is simple to visualize the efficient frontier alongside the two efficient portfolios within one powerful figure using <code>ggplot2</code> (see <a href="#fig-106">Figure&nbsp;6</a>). We also add the individual stocks in the same call. We compute annualized returns based on the simple assumption that monthly returns are independent and identically distributed. Thus, the average annualized return is just 12 times the expected monthly return.</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>mvp_return <span class="op">=</span> (mu.T <span class="op">@</span> mvp_weights)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>mvp_volatility <span class="op">=</span> np.sqrt(mvp_weights.T <span class="op">@</span> sigma <span class="op">@</span> mvp_weights)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>efp_return <span class="op">=</span> mu_bar</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>efp_volatility <span class="op">=</span> np.sqrt(efp_weights.T <span class="op">@</span> sigma <span class="op">@</span> efp_weights)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>res_figure <span class="op">=</span> (ggplot(res, aes(x<span class="op">=</span><span class="st">"sd"</span>, </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>                              y<span class="op">=</span><span class="st">"mu"</span>))</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> geom_point()</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> geom_point(pd.DataFrame({<span class="st">"mu"</span>: [mvp_return, efp_return],</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"sd"</span>: [mvp_volatility, efp_volatility]}),</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>              size<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> geom_point(pd.DataFrame({<span class="st">"mu"</span>: mu, </span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"sd"</span>: np.sqrt(np.diag(sigma))}))</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> labs(x<span class="op">=</span><span class="st">"Annualized standard deviation"</span>,</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Annualized expected return"</span>,</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Efficient frontier for DOW index constituents"</span>)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> scale_x_continuous(labels<span class="op">=</span>percent_format())</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a> <span class="op">+</span> scale_y_continuous(labels<span class="op">=</span>percent_format())</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>res_figure.draw()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div id="fig-106" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="introduction-to-tidy-finance_files/figure-html/fig-106-output-1.png" class="img-fluid figure-img" alt="Title: Efficient frontier for DOW index constituents. The figure shows DOW index constituents in a mean-variance diagram. A hyperbola indicates the efficient frontier of portfolios that dominate the individual holdings in the sense that they deliver higher expected returns for the same level of volatility."></p>
<figcaption class="figure-caption">Figure&nbsp;6: The big dots indicate the location of the minimum variance and the efficient portfolio which delivers 3 times the expected return of the minimum variance portfolio, respectively. The small dots indicate the location of the individual constituents.</figcaption>
</figure>
</div>
</div>
</div>
<p>The line in <a href="#fig-106">Figure&nbsp;6</a> indicates the efficient frontier: the set of portfolios a mean-variance efficient investor would choose from. Compare the performance relative to the individual assets (the dots) - it should become clear that diversifying yields massive performance gains (at least as long as we take the parameters <span class="math inline">\(\Sigma\)</span> and <span class="math inline">\(\mu\)</span> as given).</p>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<ol type="1">
<li>Download daily prices for another stock market symbols of your choice from Yahoo!Finance with <code>yf.download()</code> from the <code>yfinance</code> package. Plot two time series of the symbol’s un-adjusted and adjusted closing prices. Explain the differences.</li>
<li>Compute daily net returns for the asset and visualize the distribution of daily returns in a histogram. Also, use <code>geom_vline()</code> to add a dashed line that indicates the 5 percent quantile of the daily returns within the histogram. Compute summary statistics (mean, standard deviation, minimum and maximum) for the daily returns</li>
<li>Take your code from before and generalize it such that you can perform all the computations for an arbitrary vector of symbols (e.g., <code>symbol &lt;- ["AAPL", "MMM", "BA"]</code>). Automate the download, the plot of the price time series, and create a table of return summary statistics for this arbitrary number of assets.</li>
<li>Consider the research question: Are days with high aggregate trading volume often also days with large absolute price changes? Find an appropriate visualization to analyze the question.</li>
<li>Compute monthly returns from the downloaded stock market prices. Compute the vector of historical average returns and the sample variance-covariance matrix. Compute the minimum variance portfolio weights and the portfolio volatility and average returns. Visualize the mean-variance efficient frontier. Choose one of your assets and identify the portfolio which yields the same historical volatility but achieves the highest possible average return.</li>
<li>In the portfolio choice analysis, we restricted our sample to all assets trading every day since 2000. How is such a decision a problem when you want to infer future expected portfolio performance from the results?</li>
<li>The efficient frontier characterizes the portfolios with the highest expected return for different levels of risk, i.e., standard deviation. Identify the portfolio with the highest expected return per standard deviation. Hint: the ratio of expected return to standard deviation is an important concept in Finance.</li>
</ol>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-Goldstein2021" class="csl-entry" role="listitem">
Goldstein, Itay, Ralph S J Koijen, and Holger M. Mueller. 2021. <span>“<span class="nocase">COVID-19 and its impact on financial markets and the real economy</span>.”</span> <em><span>Review of Financial Studies</span></em> 34 (11): 5135–48. <a href="https://doi.org/10.1093/rfs/hhab085">https://doi.org/10.1093/rfs/hhab085</a>.
</div>
<div id="ref-Markowitz1952" class="csl-entry" role="listitem">
Markowitz, Harry. 1952. <span>“<span class="nocase">Portfolio selection</span>.”</span> <em><span>The Journal of Finance</span></em> 7 (1): 77–91. <a href="https://doi.org/10.1111/j.1540-6261.1952.tb01525.x">https://doi.org/10.1111/j.1540-6261.1952.tb01525.x</a>.
</div>
<div id="ref-Merton1972" class="csl-entry" role="listitem">
Merton, Robert C. 1972. <span>“<span class="nocase">An analytic derivation of the efficient portfolio frontier</span>.”</span> <em><span>Journal of Financial and Quantitative Analysis</span></em> 7 (4): 1851–72. <a href="https://doi.org/10.2307/2329621">https://doi.org/10.2307/2329621</a>.
</div>
<div id="ref-Tsay2010" class="csl-entry" role="listitem">
Tsay, Ruey S. 2010. <em><span class="nocase">Analysis of financial time series</span></em>. John Wiley &amp; Sons.
</div>
<div id="ref-Wilkinson2012" class="csl-entry" role="listitem">
Wilkinson, Leland. 2012. <em><span class="nocase">The grammar of graphics</span></em>. Springer.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.tidy-finance\.org");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../python/index.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Preface</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../python/accessing-and-managing-financial-data.html" class="pagination-link">
        <span class="nav-page-text">Accessing and Managing Financial Data</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 © Christoph Frey, Chistoph Scheuch, Stefan Voigt &amp; Patrick Weiss
  </li>  
</ul>
    <div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>