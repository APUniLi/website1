<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>B Clean enhanced TRACE with R | Tidy Finance with R</title>
<meta name="author" content="Christoph Scheuch (wikifolio Financial Technologies) and Stefan Voigt (University of Copenhagen and Danish Finance Institute) and Patrick Weiss (Vienna University of Economics and Business)">
<meta name="description" content="This appendix contains code to clean enhanced TRACE with R. It is also available via the following Github gist. Hence, you could also source the function with...">
<meta name="generator" content="bookdown 0.28 with bs4_book()">
<meta property="og:title" content="B Clean enhanced TRACE with R | Tidy Finance with R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://www.tidy-finance.org/clean-enhanced-trace-with-r.html">
<meta property="og:image" content="https://www.tidy-finance.org/cover.jpg">
<meta property="og:description" content="This appendix contains code to clean enhanced TRACE with R. It is also available via the following Github gist. Hence, you could also source the function with...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="B Clean enhanced TRACE with R | Tidy Finance with R">
<meta name="twitter:description" content="This appendix contains code to clean enhanced TRACE with R. It is also available via the following Github gist. Hence, you could also source the function with...">
<meta name="twitter:image" content="https://www.tidy-finance.org/cover.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.0/transition.js"></script><script src="libs/bs3compat-0.4.0/tabs.js"></script><script src="libs/bs3compat-0.4.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-DH3KZSMJ5W"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-DH3KZSMJ5W');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Tidy Finance with R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li class="book-part">Getting started</li>
<li><a class="" href="introduction-to-tidy-finance.html"><span class="header-section-number">1</span> Introduction to Tidy Finance</a></li>
<li class="book-part">Financial data</li>
<li><a class="" href="accessing-managing-financial-data.html"><span class="header-section-number">2</span> Accessing &amp; managing financial data</a></li>
<li><a class="" href="wrds-crsp-and-compustat.html"><span class="header-section-number">3</span> WRDS, CRSP, and Compustat</a></li>
<li><a class="" href="trace-and-fisd.html"><span class="header-section-number">4</span> TRACE and FISD</a></li>
<li class="book-part">Asset pricing</li>
<li><a class="" href="beta-estimation.html"><span class="header-section-number">5</span> Beta estimation</a></li>
<li><a class="" href="univariate-portfolio-sorts.html"><span class="header-section-number">6</span> Univariate portfolio sorts</a></li>
<li><a class="" href="size-sorts-and-p-hacking.html"><span class="header-section-number">7</span> Size sorts and p-hacking</a></li>
<li><a class="" href="value-and-bivariate-sorts.html"><span class="header-section-number">8</span> Value and bivariate sorts</a></li>
<li><a class="" href="replicating-fama-french-factors.html"><span class="header-section-number">9</span> Replicating Fama &amp; French factors</a></li>
<li><a class="" href="fama-macbeth-regressions.html"><span class="header-section-number">10</span> Fama-MacBeth regressions</a></li>
<li class="book-part">Modeling &amp; machine learning</li>
<li><a class="" href="fixed-effects-and-clustered-standard-errors.html"><span class="header-section-number">11</span> Fixed effects and clustered standard errors</a></li>
<li><a class="" href="factor-selection-via-machine-learning.html"><span class="header-section-number">12</span> Factor selection via machine learning</a></li>
<li><a class="" href="option-pricing-via-machine-learning.html"><span class="header-section-number">13</span> Option pricing via machine learning</a></li>
<li class="book-part">Portfolio optimization</li>
<li><a class="" href="parametric-portfolio-policies.html"><span class="header-section-number">14</span> Parametric portfolio policies</a></li>
<li><a class="" href="constrained-optimization-and-backtesting.html"><span class="header-section-number">15</span> Constrained optimization and backtesting</a></li>
<li class="book-part">References</li>
<li><a class="" href="references.html">References</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="cover-design.html"><span class="header-section-number">A</span> Cover design</a></li>
<li><a class="active" href="clean-enhanced-trace-with-r.html"><span class="header-section-number">B</span> Clean enhanced TRACE with R</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/voigtstefan/tidy_finance">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="clean-enhanced-trace-with-r" class="section level1" number="17">
<h1>
<span class="header-section-number">B</span> Clean enhanced TRACE with R<a class="anchor" aria-label="anchor" href="#clean-enhanced-trace-with-r"><i class="fas fa-link"></i></a>
</h1>
<p>This appendix contains code to clean enhanced TRACE with R. It is also available via the following Github <a href="https://gist.github.com/patrick-weiss/3a05b3ab281563b2e94858451c2eb3a4">gist</a>. Hence, you could also source the function with <code>devtools::source_gist("3a05b3ab281563b2e94858451c2eb3a4")</code>. We need this function in Chapter 4 to download and clean enhanced TRACE trade messages following <span class="citation">Dick-Nielsen (<a href="references.html#ref-Dick2009" role="doc-biblioref">2009</a>)</span> and <span class="citation">Dick-Nielsen (<a href="references.html#ref-Dick2014" role="doc-biblioref">2014</a>)</span> for enhanced TRACE specifically. WRDS provides SAS code to clean enhanced TRACE data.</p>
<p>The function takes a vector of CUSIPs (in <code>cusips</code>), a connection to WRDS (<code>connection</code>) explained in chapter 3, and a start and end date (<code>start_date</code> and <code>end_date</code>, respectively). Specifying too many CUSIPs will result in very slow downloads and a potential failure due to the size of the request to WRDS. The dates should be within the coverage of TRACE itself, i.e., starting after 2002, and the dates should be supplied using the class date. The output of the function contains all valid trade messages for the selected CUSIPs over the specified period.</p>
<div class="sourceCode" id="cb296"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clean_enhanced_trace</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cusips</span>, </span>
<span>                                 <span class="va">connection</span>, </span>
<span>                                 <span class="va">start_date</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="st">"2002-01-01"</span><span class="op">)</span>, </span>
<span>                                 <span class="va">end_date</span> <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/now.html">today</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Packages (required)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/">dbplyr</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rpostgres.r-dbi.org">RPostgres</a></span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Function checks ---------------------------------------------------------</span></span>
<span>  <span class="co"># Input parameters</span></span>
<span>  <span class="co">## Cusips</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">cusips</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">cusips</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Check cusips."</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## Dates</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/date_utils.html">is.Date</a></span><span class="op">(</span><span class="va">start_date</span><span class="op">)</span> <span class="op">|</span> <span class="op">!</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/date_utils.html">is.Date</a></span><span class="op">(</span><span class="va">end_date</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Dates needed"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">start_date</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="st">"2002-01-01"</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"TRACE starts later."</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">end_date</span> <span class="op">&gt;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/now.html">today</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"TRACE does not predict the future."</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">start_date</span> <span class="op">&gt;=</span> <span class="va">end_date</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Date conflict."</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## Connection</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu">dbIsValid</span><span class="op">(</span><span class="va">connection</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Connection issue."</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Enhanced Trace ----------------------------------------------------------</span></span>
<span>  <span class="co"># Main file</span></span>
<span>  <span class="va">trace_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">connection</span>, </span>
<span>                   <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/in_schema.html">in_schema</a></span><span class="op">(</span><span class="st">"trace"</span>, <span class="st">"trace_enhanced"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cusip_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">cusips</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">trd_exctn_dt</span> <span class="op">&gt;=</span> <span class="va">start_date</span> <span class="op">&amp;</span> <span class="va">trd_exctn_dt</span> <span class="op">&lt;=</span> <span class="va">end_date</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">cusip_id</span>, <span class="va">msg_seq_nb</span>, <span class="va">orig_msg_seq_nb</span>,</span>
<span>           <span class="va">entrd_vol_qt</span>, <span class="va">rptd_pr</span>, <span class="va">yld_pt</span>, <span class="va">rpt_side_cd</span>, <span class="va">cntra_mp_id</span>,</span>
<span>           <span class="va">trd_exctn_dt</span>, <span class="va">trd_exctn_tm</span>, <span class="va">trd_rpt_dt</span>, <span class="va">trd_rpt_tm</span>, </span>
<span>           <span class="va">pr_trd_dt</span>, <span class="va">trc_st</span>, <span class="va">asof_cd</span>, <span class="va">wis_fl</span>, </span>
<span>           <span class="va">days_to_sttl_ct</span>, <span class="va">stlmnt_dt</span>, <span class="va">spcl_trd_fl</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Enhanced Trace: Post 06-02-2012 -----------------------------------------</span></span>
<span>  <span class="co"># Trades (trc_st = T) and correction (trc_st = R)</span></span>
<span>  <span class="va">trace_post_TR</span> <span class="op">&lt;-</span> <span class="va">trace_all</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">(</span><span class="va">trc_st</span> <span class="op">==</span> <span class="st">"T"</span> <span class="op">|</span> <span class="va">trc_st</span> <span class="op">==</span> <span class="st">"R"</span><span class="op">)</span>,</span>
<span>           <span class="va">trd_rpt_dt</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="st">"2012-02-06"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Cancelations (trc_st = X) and correction cancelations (trc_st = C)</span></span>
<span>  <span class="va">trace_post_XC</span> <span class="op">&lt;-</span> <span class="va">trace_all</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">(</span><span class="va">trc_st</span> <span class="op">==</span> <span class="st">"X"</span> <span class="op">|</span> <span class="va">trc_st</span> <span class="op">==</span> <span class="st">"C"</span><span class="op">)</span>,</span>
<span>           <span class="va">trd_rpt_dt</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="st">"2012-02-06"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Cleaning corrected and cancelled trades</span></span>
<span>  <span class="va">trace_post_TR</span> <span class="op">&lt;-</span> <span class="va">trace_post_TR</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">trace_post_XC</span>,</span>
<span>              by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cusip_id"</span>, <span class="st">"msg_seq_nb"</span>, <span class="st">"entrd_vol_qt"</span>, </span>
<span>                     <span class="st">"rptd_pr"</span>, <span class="st">"rpt_side_cd"</span>, <span class="st">"cntra_mp_id"</span>, </span>
<span>                     <span class="st">"trd_exctn_dt"</span>, <span class="st">"trd_exctn_tm"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Reversals (trc_st = Y)</span></span>
<span>  <span class="va">trace_post_Y</span> <span class="op">&lt;-</span> <span class="va">trace_all</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">trc_st</span> <span class="op">==</span> <span class="st">"Y"</span>,</span>
<span>           <span class="va">trd_rpt_dt</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="st">"2012-02-06"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Clean reversals</span></span>
<span>  <span class="co">## match the orig_msg_seq_nb of the Y-message to </span></span>
<span>  <span class="co">## the msg_seq_nb of the main message</span></span>
<span>  <span class="va">trace_post</span> <span class="op">&lt;-</span> <span class="va">trace_post_TR</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">trace_post_Y</span>,</span>
<span>              by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cusip_id"</span>, <span class="st">"msg_seq_nb"</span> <span class="op">=</span> <span class="st">"orig_msg_seq_nb"</span>, </span>
<span>                     <span class="st">"entrd_vol_qt"</span>, <span class="st">"rptd_pr"</span>, <span class="st">"rpt_side_cd"</span>, </span>
<span>                     <span class="st">"cntra_mp_id"</span>, <span class="st">"trd_exctn_dt"</span>, <span class="st">"trd_exctn_tm"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># Enhanced TRACE: Pre 06-02-2012 ------------------------------------------</span></span>
<span>  <span class="co"># Cancelations (trc_st = C)</span></span>
<span>  <span class="va">trace_pre_C</span> <span class="op">&lt;-</span> <span class="va">trace_all</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">trc_st</span> <span class="op">==</span> <span class="st">"C"</span>,</span>
<span>           <span class="va">trd_rpt_dt</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="st">"2012-02-06"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Trades w/o cancelations</span></span>
<span>  <span class="co">## match the orig_msg_seq_nb of the C-message </span></span>
<span>  <span class="co">## to the msg_seq_nb of the main message</span></span>
<span>  <span class="va">trace_pre_T</span> <span class="op">&lt;-</span> <span class="va">trace_all</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">trc_st</span> <span class="op">==</span> <span class="st">"T"</span>,</span>
<span>           <span class="va">trd_rpt_dt</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="st">"2012-02-06"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">trace_pre_C</span>, </span>
<span>              by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cusip_id"</span>, <span class="st">"msg_seq_nb"</span> <span class="op">=</span> <span class="st">"orig_msg_seq_nb"</span>, </span>
<span>                     <span class="st">"entrd_vol_qt"</span>, <span class="st">"rptd_pr"</span>, <span class="st">"rpt_side_cd"</span>, </span>
<span>                     <span class="st">"cntra_mp_id"</span>, <span class="st">"trd_exctn_dt"</span>, <span class="st">"trd_exctn_tm"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Corrections (trc_st = W) - W can also correct a previous W</span></span>
<span>  <span class="va">trace_pre_W</span> <span class="op">&lt;-</span> <span class="va">trace_all</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">trc_st</span> <span class="op">==</span> <span class="st">"W"</span>,</span>
<span>           <span class="va">trd_rpt_dt</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="st">"2012-02-06"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Implement corrections in a loop</span></span>
<span>  <span class="co">## Correction control</span></span>
<span>  <span class="va">correction_control</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">trace_pre_W</span><span class="op">)</span></span>
<span>  <span class="va">correction_control_last</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">trace_pre_W</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## Correction loop</span></span>
<span>  <span class="kw">while</span><span class="op">(</span><span class="va">correction_control</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Corrections that correct some msg</span></span>
<span>    <span class="va">trace_pre_W_correcting</span> <span class="op">&lt;-</span> <span class="va">trace_pre_W</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">trace_pre_T</span>, </span>
<span>                by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cusip_id"</span>, <span class="st">"trd_exctn_dt"</span>,</span>
<span>                       <span class="st">"orig_msg_seq_nb"</span> <span class="op">=</span> <span class="st">"msg_seq_nb"</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Corrections that do not correct some msg</span></span>
<span>    <span class="va">trace_pre_W</span> <span class="op">&lt;-</span> <span class="va">trace_pre_W</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">trace_pre_T</span>, </span>
<span>                by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cusip_id"</span>, <span class="st">"trd_exctn_dt"</span>,</span>
<span>                       <span class="st">"orig_msg_seq_nb"</span> <span class="op">=</span> <span class="st">"msg_seq_nb"</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Delete msgs that are corrected and add correction msgs</span></span>
<span>    <span class="va">trace_pre_T</span> <span class="op">&lt;-</span> <span class="va">trace_pre_T</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">trace_pre_W_correcting</span>, </span>
<span>                by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cusip_id"</span>, <span class="st">"trd_exctn_dt"</span>,</span>
<span>                       <span class="st">"msg_seq_nb"</span> <span class="op">=</span> <span class="st">"orig_msg_seq_nb"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/setops.html">union_all</a></span><span class="op">(</span><span class="va">trace_pre_W_correcting</span><span class="op">)</span> </span>
<span>    </span>
<span>    <span class="co"># Escape if no corrections remain or they cannot be matched</span></span>
<span>    <span class="va">correction_control</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">trace_pre_W</span><span class="op">)</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">correction_control</span> <span class="op">==</span> <span class="va">correction_control_last</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">correction_control</span> <span class="op">&lt;-</span> <span class="fl">0</span> </span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">correction_control_last</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">trace_pre_W</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># Clean reversals</span></span>
<span>  <span class="co">## Record reversals</span></span>
<span>  <span class="va">trace_pre_R</span> <span class="op">&lt;-</span> <span class="va">trace_pre_T</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">asof_cd</span> <span class="op">==</span> <span class="st">'R'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cusip_id</span>, <span class="va">trd_exctn_dt</span>, <span class="va">entrd_vol_qt</span>, </span>
<span>             <span class="va">rptd_pr</span>, <span class="va">rpt_side_cd</span>, <span class="va">cntra_mp_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">trd_exctn_tm</span>, <span class="va">trd_rpt_dt</span>, <span class="va">trd_rpt_tm</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>seq <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## Remove reversals and the reversed trade</span></span>
<span>  <span class="va">trace_pre</span> <span class="op">&lt;-</span> <span class="va">trace_pre_T</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">asof_cd</span><span class="op">)</span> <span class="op">|</span> <span class="op">!</span><span class="op">(</span><span class="va">asof_cd</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'R'</span>, <span class="st">'X'</span>, <span class="st">'D'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cusip_id</span>, <span class="va">trd_exctn_dt</span>, <span class="va">entrd_vol_qt</span>, </span>
<span>             <span class="va">rptd_pr</span>, <span class="va">rpt_side_cd</span>, <span class="va">cntra_mp_id</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">trd_exctn_tm</span>, <span class="va">trd_rpt_dt</span>, <span class="va">trd_rpt_tm</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>seq <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">trace_pre_R</span>,</span>
<span>              by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cusip_id"</span>, <span class="st">"trd_exctn_dt"</span>, <span class="st">"entrd_vol_qt"</span>, </span>
<span>                     <span class="st">"rptd_pr"</span>, <span class="st">"rpt_side_cd"</span>, <span class="st">"cntra_mp_id"</span>, <span class="st">"seq"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">seq</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># Agency trades -----------------------------------------------------------</span></span>
<span>  <span class="co"># Combine pre and post trades</span></span>
<span>  <span class="va">trace_clean</span> <span class="op">&lt;-</span> <span class="va">trace_post</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/setops.html">union_all</a></span><span class="op">(</span><span class="va">trace_pre</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Keep angency sells and unmatched agency buys</span></span>
<span>  <span class="co">## Agency sells</span></span>
<span>  <span class="va">trace_agency_sells</span> <span class="op">&lt;-</span> <span class="va">trace_clean</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cntra_mp_id</span> <span class="op">==</span> <span class="st">"D"</span>,</span>
<span>           <span class="va">rpt_side_cd</span> <span class="op">==</span> <span class="st">"S"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Agency buys that are unmatched</span></span>
<span>  <span class="va">trace_agency_buys_filtered</span> <span class="op">&lt;-</span> <span class="va">trace_clean</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cntra_mp_id</span> <span class="op">==</span> <span class="st">"D"</span>,</span>
<span>           <span class="va">rpt_side_cd</span> <span class="op">==</span> <span class="st">"B"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">trace_agency_sells</span>, </span>
<span>              by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cusip_id"</span>, <span class="st">"trd_exctn_dt"</span>, </span>
<span>                     <span class="st">"entrd_vol_qt"</span>, <span class="st">"rptd_pr"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Agency clean</span></span>
<span>  <span class="va">trace_clean</span> <span class="op">&lt;-</span> <span class="va">trace_clean</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cntra_mp_id</span> <span class="op">==</span> <span class="st">"C"</span><span class="op">)</span>  <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/setops.html">union_all</a></span><span class="op">(</span><span class="va">trace_agency_sells</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/setops.html">union_all</a></span><span class="op">(</span><span class="va">trace_agency_buys_filtered</span><span class="op">)</span> </span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># Additional Filters ------------------------------------------------------</span></span>
<span>  <span class="va">trace_add_filters</span> <span class="op">&lt;-</span> <span class="va">trace_clean</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>days_to_sttl_ct2 <span class="op">=</span> <span class="va">stlmnt_dt</span> <span class="op">-</span> <span class="va">trd_exctn_dt</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">days_to_sttl_ct</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">days_to_sttl_ct</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">7</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">days_to_sttl_ct2</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">days_to_sttl_ct2</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">7</span>,</span>
<span>           <span class="va">wis_fl</span> <span class="op">==</span> <span class="st">"N"</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">spcl_trd_fl</span><span class="op">)</span> <span class="op">|</span> <span class="va">spcl_trd_fl</span> <span class="op">==</span> <span class="st">""</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">asof_cd</span><span class="op">)</span> <span class="op">|</span> <span class="va">asof_cd</span> <span class="op">==</span> <span class="st">""</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># Output ------------------------------------------------------------------</span></span>
<span>  <span class="co"># Only keep necessary columns</span></span>
<span>  <span class="va">trace_final</span> <span class="op">&lt;-</span> <span class="va">trace_add_filters</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">cusip_id</span>, <span class="va">trd_exctn_dt</span>, <span class="va">trd_exctn_tm</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">cusip_id</span>, <span class="va">trd_exctn_dt</span>, <span class="va">trd_exctn_tm</span>, </span>
<span>           <span class="va">rptd_pr</span>, <span class="va">entrd_vol_qt</span>, <span class="va">yld_pt</span>, <span class="va">rpt_side_cd</span>, <span class="va">cntra_mp_id</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>trd_exctn_tm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html">as_datetime</a></span><span class="op">(</span><span class="va">trd_exctn_tm</span><span class="op">)</span>, <span class="st">"%H:%M:%S"</span><span class="op">)</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="co"># Return</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">trace_final</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>

</div>






  <div class="chapter-nav">
<div class="prev"><a href="cover-design.html"><span class="header-section-number">A</span> Cover design</a></div>
<div class="empty"></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav"><li><a class="nav-link" href="#clean-enhanced-trace-with-r"><span class="header-section-number">B</span> Clean enhanced TRACE with R</a></li></ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/voigtstefan/tidy_finance/blob/main/92_appendix_trace.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/voigtstefan/tidy_finance/edit/main/92_appendix_trace.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Tidy Finance with R</strong>" was written by Christoph Scheuch (wikifolio Financial Technologies) and Stefan Voigt (University of Copenhagen and Danish Finance Institute) and Patrick Weiss (Vienna University of Economics and Business). It was last built on 2022-08-31.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
