<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 13 Parametric Portfolio Policies | Tidy Finance</title>
<meta name="author" content="Christoph Scheuch, Patrick Weiss and Stefan Voigt">
<meta name="description" content="In this section, we introduce different portfolio performance measures to evaluate and compare different allocation strategies. For this purpose, we introduce a direct (and probably simplest) way...">
<meta name="generator" content="bookdown 0.24.4 with bs4_book()">
<meta property="og:title" content="Chapter 13 Parametric Portfolio Policies | Tidy Finance">
<meta property="og:type" content="book">
<meta property="og:description" content="In this section, we introduce different portfolio performance measures to evaluate and compare different allocation strategies. For this purpose, we introduce a direct (and probably simplest) way...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 13 Parametric Portfolio Policies | Tidy Finance">
<meta name="twitter:description" content="In this section, we introduce different portfolio performance measures to evaluate and compare different allocation strategies. For this purpose, we introduce a direct (and probably simplest) way...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Tidy Finance</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Welcome</a></li>
<li><a class="" href="introduction-to-tidy-finance.html"><span class="header-section-number">2</span> Introduction to Tidy Finance</a></li>
<li><a class="" href="accessing-managing-financial-data.html"><span class="header-section-number">3</span> Accessing &amp; Managing Financial Data</a></li>
<li><a class="" href="beta-estimation.html"><span class="header-section-number">4</span> Beta Estimation</a></li>
<li><a class="" href="estimating-beta-using-daily-returns.html"><span class="header-section-number">5</span> Estimating beta using daily returns</a></li>
<li><a class="" href="analysis-and-comparison-of-beta-estimates.html"><span class="header-section-number">6</span> Analysis and comparison of beta estimates</a></li>
<li><a class="" href="univariate-sorts.html"><span class="header-section-number">7</span> Univariate Sorts</a></li>
<li><a class="" href="univariate-sorts-firm-size.html"><span class="header-section-number">8</span> Univariate Sorts: Firm Size</a></li>
<li><a class="" href="bivariate-sorts-value.html"><span class="header-section-number">9</span> Bivariate Sorts: Value</a></li>
<li><a class="" href="bivariate-sorts-replication-of-fama-french-factors.html"><span class="header-section-number">10</span> Bivariate Sorts: Replication of Fama &amp; French Factors</a></li>
<li><a class="" href="factor-selection-via-machine-learning.html"><span class="header-section-number">11</span> Factor selection via machine learning</a></li>
<li><a class="" href="option-pricing-via-machine-learning-methods.html"><span class="header-section-number">12</span> Option Pricing via Machine learning methods</a></li>
<li><a class="active" href="parametric-portfolio-policies.html"><span class="header-section-number">13</span> Parametric Portfolio Policies</a></li>
<li><a class="" href="constraint-optimization-and-portfolio-backtesting.html"><span class="header-section-number">14</span> Constraint Optimization and Portfolio Backtesting</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="parametric-portfolio-policies" class="section level1" number="13">
<h1>
<span class="header-section-number">13</span> Parametric Portfolio Policies<a class="anchor" aria-label="anchor" href="#parametric-portfolio-policies"><i class="fas fa-link"></i></a>
</h1>
<p>In this section, we introduce different portfolio performance measures to evaluate and compare different allocation strategies. For this purpose, we introduce a direct (and probably simplest) way to estimate optimal portfolio weights when stock characteristics are related to the stock’s expected return, variance, and covariance with other stocks: We parametrize weights as a function of the characteristics such that we maximize expected utility. The approach is feasible for large portfolio dimensions (such as the entire CRSP universe) and has been proposed by <span class="citation">(<a href="constraint-optimization-and-portfolio-backtesting.html#ref-Brandt2009" role="doc-biblioref">Brandt, Santa-Clara, and Valkanov 2009</a>)</span> in their influential paper <em>Parametric Portfolio Policies: Exploiting Characteristics in the Cross Section of Equity Returns</em>.</p>
<div id="data-preparation-5" class="section level2" number="13.1">
<h2>
<span class="header-section-number">13.1</span> Data preparation<a class="anchor" aria-label="anchor" href="#data-preparation-5"><i class="fas fa-link"></i></a>
</h2>
<p>To get started, we load the monthly CRSP file which forms our investment universe.</p>
<div class="sourceCode" id="cb218"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rsqlite.r-dbi.org">RSQLite</a></span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load data from database</span>
<span class="va">tidy_finance</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"data/tidy_finance.sqlite"</span>, extended_types <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">crsp_monthly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">tidy_finance</span>, <span class="st">"crsp_monthly"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>For the purpose of performance evaluation, we need monthly market returns in order to be able to compute CAPM alphas which we retrieve from the Fama French 3 factor model data.</p>
<div class="sourceCode" id="cb220"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">factors_ff_monthly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">tidy_finance</span>, <span class="st">"factors_ff_monthly"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Next we create some characteristics that have been proposed in the literature to have an effect on the expected returns or expected variances (or even higher moments) of the return distribution: We record for each firm the lagged one-year return <em>(mom)</em> defined as the compounded return between months <span class="math inline">\(t − 13\)</span> and <span class="math inline">\(t − 2\)</span> and the firm’s market equity <em>(me)</em>, defined as the log of the price per share times the number of shares outstanding</p>
<div class="sourceCode" id="cb221"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">crsp_monthly_lags</span> <span class="op">&lt;-</span> <span class="va">crsp_monthly</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span><span class="op">(</span><span class="va">permno</span>, 
            month_12 <span class="op">=</span> <span class="va">month</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m+%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>, 
            month_1 <span class="op">=</span> <span class="va">month</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m+%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,
            altprc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">altprc</span><span class="op">)</span><span class="op">)</span>

<span class="va">crsp_monthly</span> <span class="op">&lt;-</span> <span class="va">crsp_monthly</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">crsp_monthly_lags</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">month_1</span><span class="op">)</span>, 
             by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"permno"</span>, <span class="st">"month"</span> <span class="op">=</span> <span class="st">"month_12"</span><span class="op">)</span>, suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"_12"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">crsp_monthly_lags</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">month_12</span><span class="op">)</span>, 
             by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"permno"</span>, <span class="st">"month"</span> <span class="op">=</span> <span class="st">"month_1"</span><span class="op">)</span>, suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"_1"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Create characteristics for portfolio tilts</span>
<span class="va">crsp_monthly</span> <span class="op">&lt;-</span> <span class="va">crsp_monthly</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">permno</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    momentum_lag <span class="op">=</span> <span class="va">altprc_1</span> <span class="op">/</span> <span class="va">altprc_12</span>, <span class="co"># Gross returns TODO for SV: Do we need slider?</span>
    size_lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">mktcap_lag</span><span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"lag"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="parametric-portfolio-policies-1" class="section level2" number="13.2">
<h2>
<span class="header-section-number">13.2</span> Parametric Portfolio Policies<a class="anchor" aria-label="anchor" href="#parametric-portfolio-policies-1"><i class="fas fa-link"></i></a>
</h2>
<p>The basic idea of parametric portfolio weights is easy to explain: Suppose that at each date <span class="math inline">\(t\)</span> we have <span class="math inline">\(N_t\)</span> stocks in the investment universe, where each stock <span class="math inline">\(i\)</span> has return of <span class="math inline">\(r_{i, t+1}\)</span> and is associated with a vector of firm characteristics <span class="math inline">\(x_{i, t}\)</span> such as time-series momentum or the market capitalization. The investors problem is to choose portfolio weights <span class="math inline">\(w_{i,t}\)</span> to maximize the expected utility of the portfolio return:
<span class="math display">\[\begin{align}
\max_{w} E_t\left(u(r_{p, t+1})\right) = E_t\left[u\left(\sum\limits_{i=1}^{N_t}w_{i,t}r_{i,t+1}\right)\right]
\end{align}\]</span>
where <span class="math inline">\(u(\cdot)\)</span> denotes the utility function.
Where do the stock characteristics show up? We parametrize the optimal portfolio weights as a function of the stock characteristic <span class="math inline">\(x_{i,t}\)</span> with the following linear specification for the portfolio weights:
<span class="math display">\[w_{i,t} = \bar{w}_{i,t} + \frac{1}{N_t}\theta'\hat{x}_{i,t}\]</span> where <span class="math inline">\(\bar{w}_{i,t}\)</span> is the weight of a benchmark portfolio (we use the value-weighted or naive portfolio in the application below), <span class="math inline">\(\theta\)</span> is a vector of coefficients which we are going to estimate and <span class="math inline">\(\hat{x}_{i,t}\)</span> are the characteristics of stick <span class="math inline">\(i\)</span>, cross-sectionally standardized to have zero mean and unit standard deviation. Think of the portfolio strategy as a form of active portfolio management relative to a performance benchmark: Deviations from the benchmark portfolio are derived from the individual stock characteristics. Note that by construction the weights sum up to one as <span class="math inline">\(\sum_{i=1}^{N_t}\hat{x}_{i,t} = 0\)</span> due to the standardization. Note also that the coefficients are constant across assets and through time. The implicit assumption is that the characteristics fully capture all aspects of the joint distribution of returns that are relevant for forming optimal portfolios.</p>
<p>We first implement the cross-sectional standardization for the entire CRSP universe. We also keep track of (lagged) relative market capitalization which will represent the value-weighted benchmark portfolio.</p>
<div class="sourceCode" id="cb222"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">crsp_monthly</span> <span class="op">&lt;-</span> <span class="va">crsp_monthly</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="co"># number of traded assets N_t (benchmark for naive portfolio)</span>
    relative_mktcap <span class="op">=</span> <span class="va">mktcap_lag</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">mktcap_lag</span><span class="op">)</span>, <span class="co"># Value weighting benchmark</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"lag"</span><span class="op">)</span>, <span class="op">~</span> <span class="op">(</span><span class="va">.</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>, <span class="co"># standardization. Note: Code handles every column with "lag" as a characteristic)</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">mktcap_lag</span>, <span class="op">-</span><span class="va">altprc</span><span class="op">)</span></code></pre></div>
</div>
<div id="compute-portfolio-weights" class="section level2" number="13.3">
<h2>
<span class="header-section-number">13.3</span> Compute portfolio weights<a class="anchor" aria-label="anchor" href="#compute-portfolio-weights"><i class="fas fa-link"></i></a>
</h2>
<p>Next we can move to optimal choices of <span class="math inline">\(\theta\)</span>. We rewrite the optimization problem together with the weight parametrisation and can then estimate <span class="math inline">\(\theta\)</span> to maximize the objective function based on our sample
<span class="math display">\[\begin{align}
E_t\left(u(r_{p, t+1})\right) = \frac{1}{T}\sum\limits_{t=0}^{T-1}u\left(\sum\limits_{i=1}^{N_t}\left(\bar{w}_{i,t} + \frac{1}{N_t}\theta'\hat{x}_{i,t}\right)r_{i,t+1}\right).
\end{align}\]</span>
The allocation strategy is simple because the number of parameters to estimate is small. Instead of a tedious specification of the <span class="math inline">\(N_t\)</span> dimensional vector of expected returns and the <span class="math inline">\(N_t(N_t+1)/2\)</span> free elements of the variance covariance, all we need to focus on in our application is the vector <span class="math inline">\(\theta\)</span> which contains only 2 elements in our application - the relative deviation from the benchmark due to <em>size</em> and due to <em>past returns</em>.</p>
<p>To get a feeling on the performance of such an allocation strategy we start with an arbitrary vector <span class="math inline">\(\theta\)</span> - the next step is then to choose <span class="math inline">\(\theta\)</span> in an optimal fashion to maximize the objective function.</p>
<div class="sourceCode" id="cb223"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Automatic detection of parameters and initialization of parameter vector theta</span>
<span class="va">number_of_param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"lag"</span>, <span class="va">crsp_monthly</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="va">number_of_param</span><span class="op">)</span> <span class="co"># We start with some arbitrary initial values for theta</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">crsp_monthly</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"lag"</span>, <span class="va">crsp_monthly</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p>The following function computes the portfolio weights <span class="math inline">\(\bar{w}_{i,t} + \frac{1}{N_t}\theta'\hat{x}_{i,t}\)</span> according to our parametrization for a given value of <span class="math inline">\(\theta\)</span>. Everything happens within a single pipeline, thus here goes a quick walk-through:</p>
<p>We first compute <code>characteristic_tilt</code>, the tilting values <span class="math inline">\(\frac{1}{N_t}\theta'\hat{x}_{i, t}\)</span> which resemble the deviation from the benchmark portfolio. Next, we compute the benchmark portfolio <code>weight_benchmark</code> which in principle can be any reasonable set of portfolio weights. In our case we choose either the value- or equal-weighted allocation.
<code>weight_tilt</code> completes the picture and contains the final portfolio weights <code>weight_tilt = weight_benchmark + characteristic_tilt</code> which deviate from the benchmark portfolio depending on the stock characteristics.</p>
<p>The final few lines go a bit further and implement a simple version of a no-short sale constraint. While it is generally not straightforward to ensure portfolio weight constraints via the parametrization, here we simply normalize the portfolio weights such that they are enforced to be positive. Finally, we make sure that the normalized weights sum up to one again. We do so by<br><span class="math display">\[w_{i,t}^+ = \frac{\max(0, w_{i,t})}{\sum\limits_{j=1}^{N_t}\max(0, w_{i,t})}.\]</span>
Here we go to optimal portfolio weights in 20 lines.</p>
<div class="sourceCode" id="cb224"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">compute_portfolio_weights</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span>,
                                      <span class="va">data</span>,
                                      <span class="va">value_weighting</span> <span class="op">=</span> <span class="cn">TRUE</span>,
                                      <span class="va">allow_short_selling</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span>
      characteristic_tilt <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># Computes theta'x / N_t</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"lag"</span><span class="op">)</span>, <span class="op">~</span> <span class="va">.</span> <span class="op">/</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
        <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="va">theta</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span>
    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      weight_benchmark <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span> <span class="co"># Definition of the benchmark weight</span>
        <span class="va">value_weighting</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">relative_mktcap</span>,
        <span class="va">value_weighting</span> <span class="op">==</span> <span class="cn">FALSE</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">n</span>
      <span class="op">)</span>,
      weight_tilt <span class="op">=</span> <span class="va">weight_benchmark</span> <span class="op">+</span> <span class="va">characteristic_tilt</span>, <span class="co"># Parametric Portfolio Weights</span>
      weight_tilt <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span> <span class="co"># Short-sell constraint</span>
        <span class="va">allow_short_selling</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">weight_tilt</span>,
        <span class="va">allow_short_selling</span> <span class="op">==</span> <span class="cn">FALSE</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">weight_tilt</span><span class="op">)</span>
      <span class="op">)</span>,
      weight_tilt <span class="op">=</span> <span class="va">weight_tilt</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">weight_tilt</span><span class="op">)</span> <span class="co"># Weights sum up to 1</span>
    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Done! Next step is to compute the portfolio weights for a given vector <span class="math inline">\(\theta\)</span> at your convenience. In the example below we use the value weighted portfolio as a benchmark and allow negative portfolio weights.</p>
<div class="sourceCode" id="cb225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">weights_crsp</span> <span class="op">&lt;-</span> <span class="fu">compute_portfolio_weights</span><span class="op">(</span><span class="va">theta</span>,
  <span class="va">crsp_monthly</span>,
  value_weighting <span class="op">=</span> <span class="cn">TRUE</span>,
  allow_short_selling <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="portfolio-perfomance" class="section level2" number="13.4">
<h2>
<span class="header-section-number">13.4</span> Portfolio perfomance<a class="anchor" aria-label="anchor" href="#portfolio-perfomance"><i class="fas fa-link"></i></a>
</h2>
<p>Are these weights optimal in any way? Most likely not as we chose <span class="math inline">\(\theta\)</span> arbitrarily. In order to evaluate the performance of an allocation strategy, one can think of many different approaches. In their original paper, <span class="citation">(<a href="constraint-optimization-and-portfolio-backtesting.html#ref-Brandt2009" role="doc-biblioref">Brandt, Santa-Clara, and Valkanov 2009</a>)</span> focus on a simple evaluation of the hypothetical utility of an agent equipped with a power utility function <span class="math inline">\(u_\gamma(r) = \frac{(1 + r)^\gamma}{1-\gamma}\)</span>, where <span class="math inline">\(\gamma\)</span> is the risk aversion factor.</p>
<div class="sourceCode" id="cb226"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">power_utility</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">r</span>, <span class="va">gamma</span> <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">{</span> 
  <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">r</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">gamma</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">gamma</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>No doubt, there are many more ways to evaluate a portfolio. The function below provides a summary of all kinds of interesting measures which all can be considered relevant.
Do we need all these evaluation measures? It depends: The original paper only cares about
expected utility in order to choose <span class="math inline">\(\theta\)</span>. But if you want to choose optimal values that achieve the highest performance while putting some constraints on your portfolio weights it is helpful to have everything in one function.</p>
<div class="sourceCode" id="cb227"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">evaluate_portfolio</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">weights_crsp</span>,
                               <span class="va">full_evaluation</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span>

  <span class="va">evaluation</span> <span class="op">&lt;-</span> <span class="va">weights_crsp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="co"># Compute monthly portfolio returns</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
      return_tilt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">ret_excess</span>, <span class="va">weight_tilt</span><span class="op">)</span>,
      return_benchmark <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">ret_excess</span>, <span class="va">weight_benchmark</span><span class="op">)</span>
    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">month</span>, values_to <span class="op">=</span> <span class="st">"portfolio_return"</span>, names_to <span class="op">=</span> <span class="st">"model"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">factors_ff_monthly</span>, by <span class="op">=</span> <span class="st">"month"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># FF data to compute alpha</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
      <span class="st">"Expected utility"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu">power_utility</span><span class="op">(</span><span class="va">portfolio_return</span><span class="op">)</span><span class="op">)</span>,
      <span class="st">"Average return"</span> <span class="op">=</span> <span class="fl">100</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fl">12</span> <span class="op">*</span> <span class="va">portfolio_return</span><span class="op">)</span>,
      <span class="st">"SD return"</span> <span class="op">=</span> <span class="fl">100</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">portfolio_return</span><span class="op">)</span>,
      <span class="st">"Sharpe ratio"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">portfolio_return</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">portfolio_return</span><span class="op">)</span>,
      <span class="st">"CAPM alpha"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coefficients</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">portfolio_return</span> <span class="op">~</span> <span class="va">mkt_excess</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
      <span class="st">"Market beta"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coefficients</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">portfolio_return</span> <span class="op">~</span> <span class="va">mkt_excess</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
    <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"return_"</span>, <span class="st">""</span>, <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">model</span>, names_to <span class="op">=</span> <span class="st">"measure"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">model</span>, values_from <span class="op">=</span> <span class="va">value</span><span class="op">)</span>

  <span class="kw">if</span> <span class="op">(</span><span class="va">full_evaluation</span><span class="op">)</span> <span class="op">{</span> <span class="co"># additional values based on the portfolio weights</span>
    <span class="va">weight_evaluation</span> <span class="op">&lt;-</span> <span class="va">weights_crsp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">month</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"weight"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">month</span>, values_to <span class="op">=</span> <span class="st">"weight"</span>, names_to <span class="op">=</span> <span class="st">"model"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">month</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
        <span class="st">"Absolute weight"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">weight</span><span class="op">)</span>,
        <span class="st">"Max. weight"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">weight</span><span class="op">)</span>,
        <span class="st">"Min. weight"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">weight</span><span class="op">)</span>,
        <span class="st">"Avg. sum of negative weights"</span> <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">weight</span><span class="op">[</span><span class="va">weight</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span>,
        <span class="st">"Avg. fraction of negative weights"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>
      <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="op">-</span><span class="va">month</span>, <span class="op">~</span> <span class="fl">100</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"weight_"</span>, <span class="st">""</span>, <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">model</span>, names_to <span class="op">=</span> <span class="st">"measure"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">model</span>, values_from <span class="op">=</span> <span class="va">value</span><span class="op">)</span>
    <span class="va">evaluation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">evaluation</span>, <span class="va">weight_evaluation</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">evaluation</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Let’s take a look at the different portfolio strategies and evaluation measures.</p>
<div class="sourceCode" id="cb228"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">evaluate_portfolio</span><span class="op">(</span><span class="va">weights_crsp</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">kableExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
measure
</th>
<th style="text-align:right;">
benchmark
</th>
<th style="text-align:right;">
tilt
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Expected utility
</td>
<td style="text-align:right;">
-0.249
</td>
<td style="text-align:right;">
-0.261
</td>
</tr>
<tr>
<td style="text-align:left;">
Average return
</td>
<td style="text-align:right;">
6.858
</td>
<td style="text-align:right;">
-0.051
</td>
</tr>
<tr>
<td style="text-align:left;">
SD return
</td>
<td style="text-align:right;">
15.348
</td>
<td style="text-align:right;">
20.237
</td>
</tr>
<tr>
<td style="text-align:left;">
Sharpe ratio
</td>
<td style="text-align:right;">
0.129
</td>
<td style="text-align:right;">
-0.001
</td>
</tr>
<tr>
<td style="text-align:left;">
CAPM alpha
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
-0.005
</td>
</tr>
<tr>
<td style="text-align:left;">
Market beta
</td>
<td style="text-align:right;">
0.992
</td>
<td style="text-align:right;">
0.904
</td>
</tr>
<tr>
<td style="text-align:left;">
Absolute weight
</td>
<td style="text-align:right;">
0.025
</td>
<td style="text-align:right;">
0.061
</td>
</tr>
<tr>
<td style="text-align:left;">
Max. weight
</td>
<td style="text-align:right;">
3.516
</td>
<td style="text-align:right;">
3.647
</td>
</tr>
<tr>
<td style="text-align:left;">
Min. weight
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
-0.139
</td>
</tr>
<tr>
<td style="text-align:left;">
Avg. sum of negative weights
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
72.910
</td>
</tr>
<tr>
<td style="text-align:left;">
Avg. fraction of negative weights
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
49.366
</td>
</tr>
</tbody>
</table></div>
<p>The value weighted portfolio delivers an annualized return of above 6 percent and clearly outperforms the tilted portfolio, irrespective of whether we evaluate expected utility, the Sharpe ratio or the CAPM alpha. We can conclude the the market beta is close to one for both strategies (naturally almost identically 1 for the value-weighted benchmark portfolio). When it comes to the distribution of the portfolio weights, we see that the benchmark portfolio weight takes less extreme positions (lower average absolute weights and lower maximum weight). By definition, the value-weighted benchmark does not take any negative positions, while the tilted portfolio also takes short positions.</p>
</div>
<div id="optimal-parameter-choice" class="section level2" number="13.5">
<h2>
<span class="header-section-number">13.5</span> Optimal parameter choice<a class="anchor" aria-label="anchor" href="#optimal-parameter-choice"><i class="fas fa-link"></i></a>
</h2>
<p>Next we move to a choice of <span class="math inline">\(\theta\)</span> that actually aims to to improve some (or all) of the performance measures. We first define a helper function <code>compute_objective_function</code> which is then passed to R’s optimization schemes.</p>
<div class="sourceCode" id="cb229"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">compute_objective_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span>,
                                       <span class="va">data</span>,
                                       <span class="va">objective_measure</span> <span class="op">=</span> <span class="st">"Expected utility"</span>,
                                       <span class="va">value_weighting</span>,
                                       <span class="va">allow_short_selling</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">processed_data</span> <span class="op">&lt;-</span> <span class="fu">compute_portfolio_weights</span><span class="op">(</span>
    <span class="va">theta</span>,
    <span class="va">data</span>,
    <span class="va">value_weighting</span>,
    <span class="va">allow_short_selling</span>
  <span class="op">)</span>

  <span class="va">objective_function</span> <span class="op">&lt;-</span> <span class="fu">evaluate_portfolio</span><span class="op">(</span><span class="va">processed_data</span>, full_evaluation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">measure</span> <span class="op">==</span> <span class="va">objective_measure</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">tilt</span><span class="op">)</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">objective_function</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>You may wonder why we return the negative value of the objective function. This is simply due to the common convention for optimization procedures to search minima as a default. By minimizing the negative value of the objective function we will get the maximum value as a result.
Optimization in R in its most basic form is done by <code>optim</code>. As main inputs, the function requires an initial “guess” of the parameters, and the function to minimize. We are fully equipped to compute the optimal values of <span class="math inline">\(\hat\theta\)</span> which maximize hypothetical expected utility of the investor.</p>
<div class="sourceCode" id="cb230"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">optimal_theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span>
  par <span class="op">=</span> <span class="va">theta</span>, <span class="co"># Initial vector of thetas (can be any value)</span>
  <span class="va">compute_objective_function</span>,
  objective_measure <span class="op">=</span> <span class="st">"Expected utility"</span>,
  data <span class="op">=</span> <span class="va">crsp_monthly</span>,
  value_weighting <span class="op">=</span> <span class="cn">TRUE</span>,
  allow_short_selling <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span>

<span class="va">optimal_theta</span><span class="op">$</span><span class="va">par</span> <span class="co"># Optimal values</span></code></pre></div>
<pre><code>## momentum_lag     size_lag 
##    0.5889182   -2.0715581</code></pre>
<p>The chosen values of <span class="math inline">\(\theta\)</span> are easy to interpret on an intuitive basis: Expected utility increases by tilting weights from the value weighted portfolio towards smaller stocks (negative coefficient for size) and towards past winners (positive value for momentum).</p>
</div>
<div id="more-model-specifications" class="section level2" number="13.6">
<h2>
<span class="header-section-number">13.6</span> More model specifications<a class="anchor" aria-label="anchor" href="#more-model-specifications"><i class="fas fa-link"></i></a>
</h2>
<p>A final open question is then: How does the portfolio perform for different model specifications? For that purpose we compute the performance of a number of different modelling choices based on the entire CRSP sample. The few lines below perform all the heavy lifting.</p>
<div class="sourceCode" id="cb232"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">full_model_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html">expand_grid</a></span><span class="op">(</span>
  value_weighting <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>,
  allow_short_selling <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>,
  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">crsp_monthly</span><span class="op">)</span>
<span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>optimal_theta <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">pmap</a></span><span class="op">(</span>
    .l <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      <span class="va">data</span>,
      <span class="va">value_weighting</span>,
      <span class="va">allow_short_selling</span>
    <span class="op">)</span>,
    .f <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span>
      par <span class="op">=</span> <span class="va">theta</span>,
      <span class="va">compute_objective_function</span>,
      data <span class="op">=</span> <span class="va">..1</span>,
      objective_measure <span class="op">=</span> <span class="st">"Expected utility"</span>,
      value_weighting <span class="op">=</span> <span class="va">..2</span>,
      allow_short_selling <span class="op">=</span> <span class="va">..3</span><span class="op">)</span><span class="op">$</span><span class="va">par</span>
  <span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Finally, we can compare the results. The table below shows summary statistics for all possible combinations: Equal- or Value-weighted benchmark portfolio, with or without short-selling constraints, tilted towards maximizing expected utility.</p>
<div class="sourceCode" id="cb233"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">performance_table</span> <span class="op">&lt;-</span> <span class="va">full_model_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    processed_data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">pmap</a></span><span class="op">(</span>
      .l <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">optimal_theta</span>, <span class="va">data</span>, <span class="va">value_weighting</span>, <span class="va">allow_short_selling</span><span class="op">)</span>,
      .f <span class="op">=</span> <span class="op">~</span> <span class="fu">compute_portfolio_weights</span><span class="op">(</span><span class="va">..1</span>, <span class="va">..2</span>, <span class="va">..3</span>, <span class="va">..4</span><span class="op">)</span>
    <span class="op">)</span>,
    portfolio_evaluation <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">processed_data</span>, <span class="va">evaluate_portfolio</span>, full_evaluation <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">value_weighting</span>, <span class="va">allow_short_selling</span>, <span class="va">portfolio_evaluation</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">portfolio_evaluation</span><span class="op">)</span>

<span class="va">performance_table</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>
    <span class="st">" "</span> <span class="op">=</span> <span class="va">benchmark</span>,
    Optimal <span class="op">=</span> <span class="va">tilt</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    value_weighting <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
      <span class="va">value_weighting</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"VW"</span>,
      <span class="va">value_weighting</span> <span class="op">==</span> <span class="cn">FALSE</span> <span class="op">~</span> <span class="st">"EW"</span>
    <span class="op">)</span>,
    allow_short_selling <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
      <span class="va">allow_short_selling</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">""</span>,
      <span class="va">allow_short_selling</span> <span class="op">==</span> <span class="cn">FALSE</span> <span class="op">~</span> <span class="st">"(no s.)"</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>
    names_from <span class="op">=</span> <span class="va">value_weighting</span><span class="op">:</span><span class="va">allow_short_selling</span>,
    values_from <span class="op">=</span> <span class="st">" "</span><span class="op">:</span><span class="va">Optimal</span>,
    names_glue <span class="op">=</span> <span class="st">"{value_weighting} {allow_short_selling} {.value} "</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">measure</span>, <span class="va">`EW    `</span>, <span class="va">`VW    `</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"Optimal"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">kableExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
measure
</th>
<th style="text-align:right;">
EW
</th>
<th style="text-align:right;">
VW
</th>
<th style="text-align:right;">
VW Optimal
</th>
<th style="text-align:right;">
VW (no s.) Optimal
</th>
<th style="text-align:right;">
EW Optimal
</th>
<th style="text-align:right;">
EW (no s.) Optimal
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Expected utility
</td>
<td style="text-align:right;">
-0.250
</td>
<td style="text-align:right;">
-0.249
</td>
<td style="text-align:right;">
-0.246
</td>
<td style="text-align:right;">
-0.247
</td>
<td style="text-align:right;">
-0.250
</td>
<td style="text-align:right;">
-0.250
</td>
</tr>
<tr>
<td style="text-align:left;">
Average return
</td>
<td style="text-align:right;">
10.456
</td>
<td style="text-align:right;">
6.858
</td>
<td style="text-align:right;">
14.697
</td>
<td style="text-align:right;">
13.413
</td>
<td style="text-align:right;">
13.014
</td>
<td style="text-align:right;">
8.052
</td>
</tr>
<tr>
<td style="text-align:left;">
SD return
</td>
<td style="text-align:right;">
20.333
</td>
<td style="text-align:right;">
15.348
</td>
<td style="text-align:right;">
20.342
</td>
<td style="text-align:right;">
19.584
</td>
<td style="text-align:right;">
22.402
</td>
<td style="text-align:right;">
17.096
</td>
</tr>
<tr>
<td style="text-align:left;">
Sharpe ratio
</td>
<td style="text-align:right;">
0.148
</td>
<td style="text-align:right;">
0.129
</td>
<td style="text-align:right;">
0.209
</td>
<td style="text-align:right;">
0.198
</td>
<td style="text-align:right;">
0.168
</td>
<td style="text-align:right;">
0.136
</td>
</tr>
<tr>
<td style="text-align:left;">
CAPM alpha
</td>
<td style="text-align:right;">
0.002
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.007
</td>
<td style="text-align:right;">
0.005
</td>
<td style="text-align:right;">
0.005
</td>
<td style="text-align:right;">
0.001
</td>
</tr>
<tr>
<td style="text-align:left;">
Market beta
</td>
<td style="text-align:right;">
1.135
</td>
<td style="text-align:right;">
0.992
</td>
<td style="text-align:right;">
0.991
</td>
<td style="text-align:right;">
1.045
</td>
<td style="text-align:right;">
1.122
</td>
<td style="text-align:right;">
1.077
</td>
</tr>
<tr>
<td style="text-align:left;">
Absolute weight
</td>
<td style="text-align:right;">
0.025
</td>
<td style="text-align:right;">
0.025
</td>
<td style="text-align:right;">
0.040
</td>
<td style="text-align:right;">
0.025
</td>
<td style="text-align:right;">
0.027
</td>
<td style="text-align:right;">
0.025
</td>
</tr>
<tr>
<td style="text-align:left;">
Max. weight
</td>
<td style="text-align:right;">
0.025
</td>
<td style="text-align:right;">
3.516
</td>
<td style="text-align:right;">
3.331
</td>
<td style="text-align:right;">
2.643
</td>
<td style="text-align:right;">
0.367
</td>
<td style="text-align:right;">
0.297
</td>
</tr>
<tr>
<td style="text-align:left;">
Min. weight
</td>
<td style="text-align:right;">
0.025
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
-0.046
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
-0.042
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
Avg. sum of negative weights
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
31.098
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
4.040
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
Avg. fraction of negative weights
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
39.368
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
10.409
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
</tbody>
</table></div>
<p>The results indicate first that the average annualized Sharpe ratio of the equal weighted portfolio exceeded the Sharpe ratio of the value weighted benchmark portfolio. Nevertheless, starting with the value weighted portfolio as a benchmark and tilting optimally with respect to momentum and small stocks yields the highest Sharpe ratio across all specifications. Imposing no short-sale constraints does not improve the performance of the portfolios in our application.</p>
</div>
<div id="exercises-3" class="section level2" number="13.7">
<h2>
<span class="header-section-number">13.7</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-3"><i class="fas fa-link"></i></a>
</h2>
<ol style="list-style-type: decimal">
<li>How do the estimated parameters <span class="math inline">\(\hat\theta\)</span> and the portfolio performance change if your objective is to maximize the Sharpe ratio instead of hypothetical expected utility?</li>
<li>The code above is very flexible in the sense that you can easily add new firm characteristics. Construct a new characteristic and evaluate the corresponding coefficient <span class="math inline">\(\hat\theta_i\)</span>.</li>
<li>Tweak the function <code>optimal_theta</code>such that you can impose additional performance constraints in order to determine <span class="math inline">\(\hat\theta\)</span> which maximizes expected utility under the constraint that the market beta is below 1.</li>
<li>Does the portfolio performance resemble a realistic out-of-sample backtesting procedure? Verify the robustness of the results by first estimating <span class="math inline">\(\hat\theta\)</span> based on <em>past data</em> only and then use more recent periods to evaluate the actual portfolio performance.</li>
<li>By formulating the portfolio problem as a statistical estimation problem, you can easily obtain standard errors for the coefficients of the weight function. <span class="citation">(<a href="constraint-optimization-and-portfolio-backtesting.html#ref-Brandt2009" role="doc-biblioref">Brandt, Santa-Clara, and Valkanov 2009</a>)</span> provide the relevant derivations in their paper in Equation (10). Implement a small function that computes standard errors for <span class="math inline">\(\hat\theta\)</span>.</li>
</ol>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="option-pricing-via-machine-learning-methods.html"><span class="header-section-number">12</span> Option Pricing via Machine learning methods</a></div>
<div class="next"><a href="constraint-optimization-and-portfolio-backtesting.html"><span class="header-section-number">14</span> Constraint Optimization and Portfolio Backtesting</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#parametric-portfolio-policies"><span class="header-section-number">13</span> Parametric Portfolio Policies</a></li>
<li><a class="nav-link" href="#data-preparation-5"><span class="header-section-number">13.1</span> Data preparation</a></li>
<li><a class="nav-link" href="#parametric-portfolio-policies-1"><span class="header-section-number">13.2</span> Parametric Portfolio Policies</a></li>
<li><a class="nav-link" href="#compute-portfolio-weights"><span class="header-section-number">13.3</span> Compute portfolio weights</a></li>
<li><a class="nav-link" href="#portfolio-perfomance"><span class="header-section-number">13.4</span> Portfolio perfomance</a></li>
<li><a class="nav-link" href="#optimal-parameter-choice"><span class="header-section-number">13.5</span> Optimal parameter choice</a></li>
<li><a class="nav-link" href="#more-model-specifications"><span class="header-section-number">13.6</span> More model specifications</a></li>
<li><a class="nav-link" href="#exercises-3"><span class="header-section-number">13.7</span> Exercises</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Tidy Finance</strong>" was written by Christoph Scheuch, Patrick Weiss and Stefan Voigt. It was last built on 2022-01-24.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
