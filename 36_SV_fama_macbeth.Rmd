# Fama-MacBeth Regressions

The regression approach of @Fama1973 is widely used in empirical asset pricing studies. Researchers use the two-stage regression approach to estimate risk premiums in various markets, but predominately in the stock market. 
We present a simple implementation of @Fama1973 to introduce the concept of their regressions.

Frequently, the application of @Fama1973 regressions starts with the estimation of $\beta^{F_f}_{i}$ for some risk factor $F_f$ from a group of $F$ risk factors $F_1, \cdots, F_F$ for each asset $i$. 
We consider the three risk factors of @Fama1993 below and estimate the betas from the time-series regression
$$r_{i,t} = \alpha_i + \beta^M_i r^M_t + \beta^{SMB}_i r^{SMB}_t + \beta^{HML}_i r^{HML}_t + \epsilon_{i,t}.$$
More generally, we could also use asset characteristics in these regressions instead of betas. Moreover, we could also consider rolling-window estimation for betas or more evolved forecasts of betas. 
In any case, the Fama-MacBeth regressions use these exposures or characteristics in cross-sectional regressions, i.e.,
$$r_{i,t} = \alpha_i + \lambda^{M}_t \beta^M_i  + \lambda^{SMB}_t \beta^{SMB}_i + \lambda^{HML}_t \beta^{HML}_i + \epsilon_{i,t},$$ where we are interested in the compensation $\lambda^{F_f}_t$ for the exposure to each risk factor in each time point. 
The time-series average of the $\lambda^{F_f}_t$ can then be interpreted as the risk premium for the specific risk factor $F_f$.

The current chapter relies on this set of packages. 
```{r}
library(tidyverse)
library(RSQLite)
library(lubridate)
```

## Data preparation

We can illustrate @Fama1973-regressions with publicly available data from Prof. French's website. We collect the industry portfolio returns, and the three Fama-French factors from our `SQLite`-database introduced in our chapter on *"Accessing & managing financial data"*.

```{r}
tidy_finance <- dbConnect(SQLite(), "data/tidy_finance.sqlite",
  extended_types = TRUE
)

industry_returns <- tbl(tidy_finance, "industries_ff_monthly") %>% 
  collect()

factors_ff_monthly <- tbl(tidy_finance, "factors_ff_monthly") %>%
  collect()
```

We compute excess returns for the ten test assets by subtracting the risk-free rate with this data at hand. 
We also merge the three Fama-French risk factors into the data to prepare for the next step. We finally rename the market excess return to be consistent for aesthetic purposes.

```{r}
data_macbeth <- industry_returns %>%
  left_join(factors_ff_monthly, by = "month") %>%
  mutate(across(NoDur:Other, ~ . - rf)) %>%
  select(-rf)
```

If you worry about the number of test assets being too small, we agree with your concern. Yet this chapter is about introducing Fama-MacBeth regressions as a tool and not about interpreting meaningful results.

## Time-series regression: Factor exposure

The first step in many applications of Fama-MacBeth regressions is the estimation of factor betas. In our case, we have to estimate three $\beta_i$ for the three risk factors of @Fama1993. We do this by writing a function for the estimation (similar to the function in the chapter on *"Beta estimation"*) and then estimating the slope coefficients in one step. The function itself is sufficiently flexible to handle more or fewer risk factors and test assets. 

```{r}

X <- data_macbeth %>% select(NoDur:Other) %>% as.matrix()
Y <- data_macbeth %>% select(mkt_excess:hml) %>% as.matrix()
risk_exposures <- broom::tidy(lm(Y ~ X)) %>% 
  filter(term != "(Intercept)") %>% 
  mutate(response = paste0("beta_", response),
         term = gsub("X", "", term)) %>% 
  select(asset = term, response, estimate) %>% pivot_wider(names_from = "response", values_from = estimate)

risk_exposures
```

We now have three factor exposures for each of the ten test assets and are ready to turn our attention to the cross-sectional regression. At this point, you might want to reflect on the exposure estimates and analyze them in more detail. We skip this step to keep it simple.

## Cross-sectional regression: Risk premiums

To smoothly run the cross-sectional regression, we build another function as the one for the time-series estimation of risk exposures. 
This time, we regress the returns of the test assets at a particular point of time on the factor exposures of each asset. By doing so, we get an estimate of the risk premiums $\lambda^{F_f}_t$ for each point in time.

```{r}
nest_macbeth <- data_macbeth %>%
  pivot_longer(-month, names_to = "asset", values_to = "ret_exc") %>%
  left_join(risk_exposures, by = "asset") %>% 
  group_by(month) %>%
  select(-asset) %>% 
  nest()

cross_sectional_regs <- nest_macbeth %>%
  mutate(model = map(data, ~lm(ret_exc ~ ., data = .x)),
         tidy = map(model, broom::tidy),
         n = map_dbl(model, stats::nobs))

# extract average coefficient estimates
fama_macbeth_coefs <- cross_sectional_regs %>%
  unnest(tidy) %>%
  group_by(term) %>%
  summarize(coefficient = mean(estimate))
```

Now that we have the risk premiums' estimates for each period, we can average across the time-series dimension to get the expected risk premium for each risk factor.

```{r}
data_risk_premiums %>%
  select(starts_with("lambda_")) %>%
  summarize(across(everything(), ~ c(t.test(.x)$estimate, 
                                     t.test(.x)$statistic))) %>%
  bind_cols(tibble("Statistc" = c("Mean", "T-value")), .)

# compute newey-west standard errors of average coefficient estimates
newey_west_std_errors <- cross_sectional_regs %>%
  unnest(tidy) %>%
  group_by(term) %>%
  arrange(month) %>%
  group_modify(~enframe(sqrt(diag(sandwich::NeweyWest(lm(estimate ~ 1, data = .x), lag = 6))))) %>%
  select(term, nw_std_error = value)

# put coefficient estimates and standard errors together and compute t-statistics
fama_macbeth_coefs <- fama_macbeth_coefs %>%
  left_join(newey_west_std_errors, by = "term") %>%
  mutate(nw_t_stat = coefficient / nw_std_error) %>%
  select(term, coefficient, nw_t_stat) %>%
  pivot_longer(cols = c(coefficient, nw_t_stat), names_to = "statistic") %>%
  mutate(statistic = paste(term, statistic, sep = " ")) %>%
  select(-term)

# extract average number of observations
fama_macbeth_stats <- cross_sectional_regs %>%
  ungroup() %>%
  summarize(n = mean(n)) %>%
  pivot_longer(n, names_to = "statistic")

# combine desired output and return results
out <- rbind(fama_macbeth_coefs, fama_macbeth_stats)

out %>% knitr::kable(digits = 2, "pipe")

```

In this illustration, we can conclude that there is no significant risk premium for the three @Fama1993 factors. However, we would not consider this a valid or exciting answer given the limitations of the setup used here.

## Exercises

1. Download a larger sample of test assets from Kenneth French's homepage and reevaluate the risk premiums.
1. Implement a rolling-window regression for the time-series estimation of the factor exposure. Then, adapt the cross-sectional regression and compute the average risk premiums.