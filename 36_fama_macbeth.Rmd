# Fama-MacBeth Regressions

The regression approach of @Fama1973 is widely used in empirical asset pricing studies. 
Researchers use the two-stage regression approach to estimate risk premiums in various markets, but predominately in the stock market. 
In the end, Fama-MacBeth regressions are used in much the same way as portfolio sorts introduced in previous chapters.
Essentially, Fama-MacBeth regressions exploit a linear relationship between expected returns and exposure to (priced) risk factors. 
The basic idea of the regression approach is to project asset returns on factor exposures or characteristics that might resemble exposure to a risk factor in the cross section. 
The estimates are then aggregated across time to test if a risk factor is priced. 
In this chapter, we present a simple implementation of @Fama1973 to introduce the concept of their regressions. We use 49 industry portfolios as test assets to estimate the risk premium associated with the three factors included in @Fama1993.

The Fama-MacBeth procedure is a two-step approach: 
The first step uses the exposures (characteristics) as explanatory variables in $T$ cross-sectional regressions, i.e.,
$$r_{i,t} = \alpha_i + \lambda^{M}_t \beta^M_{i,t}  + \lambda^{SMB}_t \beta^{SMB}_{i,t} + \lambda^{HML}_t \beta^{HML}_{i,t} + \epsilon_{i,t}\text{, for each t}.$$ 
Here, we are interested in the compensation $\lambda^{f}_t$ for the exposure to each risk factor $\beta^{f}_{i,t}$ at each time point, i.e., the risk premium. Note the terminology: $\beta^{f}_{i,t}$ is a asset-specific characteristic. *If* there is a linear relationship between expected returns and the characteristic in a given month, we expect the regression coefficient to reflect the relationship, i.e., $\lambda_t^{f}\neq0$. 
In a second step, the time-series average $\frac{1}{T}\sum\limits_{t=1}^T \hat\lambda^{f}_t$ of the estimates $\hat\lambda^{f}_t$ can then be interpreted as the risk premium for the specific risk factor $f$.

What about the standard errors of the risk premiums? 
It turns out that you can simply run a t-test on the time-series of $\hat\lambda^{f}_t$ to find the standard error of the mean. If you worry about serial correlation in the risk premiums, the common correction for standard errors follows @Newey1987. 

Before we move to the implementation, we want to highlight that the characteristics, e.g., $\hat\beta^{f}_{i}$, are typically estimated in a separate step. You might thus worry that the errors of $\hat\beta^{f}_{i}$ impact the risk premiums' standard errors. Measurement error in $\hat\beta^{f}_{i}$ indeed affects the risk premium estimates, i.e., they lead to biased estimates. The literature provides adjustments for this bias (see, e.g., @shanken1992, @kim1995, @chen2015, among others), but also shows that the bias goes to zero as $T \to \infty$. We refer to @gagliardini2016 for an indepth discussion covering also the case of time-varying betas and estimation on individual stocks. Moroever, if you plan to use Fama-MacBeth regressions with individual stocks: @hou2020 advocate using weighed-least squares to estimate the coefficients such that they are not biased towards small firms. Without this adjustment, the high number of small firms would drive the coefficient estimates.

## Data preparation

The current chapter relies on this set of packages. 
```{r}
library(tidyverse)
library(RSQLite)
library(lubridate)
library(broom)
```

We illustrate @Fama1973-regressions with publicly available data from Prof. French's website. 
We collect the industry portfolio returns, and the three Fama-French factors from our `SQLite`-database introduced in our chapter on *"Accessing & managing financial data"*.

```{r}
tidy_finance <- dbConnect(SQLite(), "data/tidy_finance.sqlite",
  extended_types = TRUE
)

industry_returns <- tbl(tidy_finance, "industries_ff_monthly") %>% 
  collect() 

factors_ff_monthly <- tbl(tidy_finance, "factors_ff_monthly") %>%
  collect()
```

We compute excess returns for the 49 test assets by subtracting the risk-free rate with this data at hand. 
We merge the data with the three Fama-French risk factors to compute excess returns. 

```{r}
data_famamacbeth <- industry_returns %>%
    pivot_longer(cols = -month, 
               names_to = "asset", 
               values_to = "ret") %>% 
  left_join(factors_ff_monthly, by = "month") %>%
  mutate(ret_excess = ret - rf) %>%
  select(month, asset, ret_excess) 
```

## Stock characteristics

Typically, the application of @Fama1973 regressions starts with the estimation of $\beta^{f}_{i}$ for some risk factor $f$ from a group of $K$ risk factors $F_1, \cdots, F_K$ for each asset $i \in [1; N]$. 
As an example, we consider the three risk factors of @Fama1993 below and estimate the betas from $N$ time-series regressions
$$r_{i,t} = \alpha_i + \beta^M_i r^M_t + \beta^{SMB}_i r^{SMB}_t + \beta^{HML}_i r^{HML}_t + \epsilon_{i,t}\text{, for each } i.$$ We use excess returns as our dependent variable, but the approach could also incorporate raw returns which leads to a change in the interpretation of intercepts (and their standard errors have to be adjusted following @Shanken1992). 

We think about the $\beta^{f}_{i}$ as an asset characteristic. In fact, we could also use asset characteristics like firm size or book-to-market ratio directly in the cross-sectional regression and skip the time-series regressions for such variables. 
Moreover, we could also consider rolling-window estimation for betas or more evolved forecasts of betas if exposures might vary over time. For example, @Fama1973 use 60-month windows for the estimation of exposures, while others use 24-month or 36-month windows for monthly returns or 240 trading days for data on daily frequency. 

```{r}
characteristics <- data_famamacbeth %>%
  left_join(factors_ff_monthly %>% select(-rf), by = "month") %>% 
  nest(data = -asset) %>% 
    mutate(lm = map(.x = data, 
                        ~broom::tidy(lm(ret_excess ~ . - month, data = .x)))) %>% 
  unnest(lm) %>%
  filter(term != "(Intercept)") %>% 
  transmute(asset, 
            term = paste0("characteristic_", term), 
            estimate) %>% 
  pivot_wider(names_from = term, 
              values_from = estimate)

data_famamacbeth <- data_famamacbeth %>% 
  left_join(characteristics, by = "asset")
```

We now have three factor exposures for each of the 49 test assets and are ready to turn our attention to the cross-sectional regression. 

## Cross-sectional regression

Next, we run the cross-sectional regressions with the characteristics as explanatory variable for each month.  
We regress the returns of the test assets at a particular point in time on the characteristics of each asset. 
By doing so, we get an estimate of the risk premiums $\hat\lambda^{F_f}_t$ for each point in time. 

```{r}
risk_premiums <- data_famamacbeth %>%
    nest(data = -month) %>% 
    mutate(lm = map(.x = data, 
                        ~broom::tidy(lm(ret_excess ~ . - asset, data = .x)))) %>% 
  unnest(lm)
```

## Time-series aggregation

Now that we have the risk premiums' estimates for each period, we can average across the time-series dimension to get the expected risk premium for each characteristic. Similarly, we manually create the t-test statistics for each regressor, which we can then compare to usual critical values of 1.96 or 2.576 for two-tailed significance tests. We can see that our little application does not yield any significant characteristics

```{r}
risk_premiums %>% 
  group_by(term) %>% 
  summarise(risk_premium = mean(estimate), 
            t_statistic = mean(estimate) / sd(estimate) * sqrt(n()))
```

TODO: Some more meaningful and exciting conclusion :-) 

TODO: also show

## Exercises

1. Download a larger sample of test assets from Kenneth French's homepage and reevaluate the risk premiums.
1. Implement a rolling-window regression for the time-series estimation of the factor exposure. Skip one month after each rolling period before including the exposures in the cross-sectional regression to avoid a look-ahead bias. Then, adapt the cross-sectional regression and compute the average risk premiums.