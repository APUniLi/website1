{
  "hash": "95075619b6bafd9044161b2cb380f5e0",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Fixed Effects and Clustered Standard Errors\nmetadata:\n  pagetitle: Fixed Effects and Clustered Standard Errors with Python\n  description-meta: Dive into the implementation of fixed effects regressions and clustered standard errors in finance using the programming language Python. \n---\n\n\n\n::: {.callout-note}\nYou are reading **Tidy Finance with Python**. You can find the equivalent chapter for the sibling **Tidy Finance with R** [here](../r/fixed-effects-and-clustered-standard-errors.qmd).\n:::\n\nIn this chapter, we provide an intuitive introduction to the two popular concepts of *fixed effects regressions* and *clustered standard errors*. When working with regressions in empirical finance, you will sooner or later be confronted with discussions around how you deal with omitted variables bias and dependence in your residuals. The concepts we introduce in this chapter are designed to address such concerns. \n\nWe focus on a classical panel regression common to the corporate finance literature [e.g., @Fazzari1988;@Erickson2012;@Gulen2015]: firm investment modeled as a function that increases in firm cash flow and firm investment opportunities.\n\nTypically, this investment regression uses quarterly balance sheet data provided via Compustat because it allows for richer dynamics in the regressors and more opportunities to construct variables. As we focus on the implementation of fixed effects and clustered standard errors, we use the annual Compustat data from our previous chapters and leave the estimation using quarterly data as an exercise. We demonstrate below that the regression based on annual data yields qualitatively similar results to estimations based on quarterly data from the literature, namely confirming the positive relationships between investment and the two regressors.\n\nThe current chapter relies on the following set of Python packages. \n\n::: {#c6d91aae .cell execution_count=2}\n``` {.python .cell-code}\nimport pandas as pd\nimport numpy as np\nimport sqlite3\nimport datetime as dt\nimport itertools\nimport linearmodels as lm\n\nfrom regtabletotext import prettify_result, prettify_result\n```\n:::\n\n\nCompared to previous chapters, we introduce `linearmodels` [@linearmodels], which provides tools for estimating various econometric models such as panel regressions. \n\n## Data Preparation\n\nWe use CRSP and annual Compustat as data sources from our SQLite database introduced in [Accessing and Managing Financial Data](accessing-and-managing-financial-data.qmd) and [WRDS, CRSP, and Compustat](wrds-crsp-and-compustat.qmd)\n. In particular, Compustat provides balance sheet and income statement data on a firm level, while CRSP provides market valuations. \\index{Data!CRSP}\\index{Data!Compustat}\n\n::: {#884fff87 .cell execution_count=3}\n``` {.python .cell-code}\ntidy_finance = sqlite3.connect(\n  database=\"data/tidy_finance_python.sqlite\"\n)\n\ncrsp_monthly = pd.read_sql_query(\n  sql=\"SELECT gvkey, month, mktcap FROM crsp_monthly\",\n  con=tidy_finance,\n  parse_dates={\"month\"}\n)\n\ncompustat = pd.read_sql_query(\n  sql=(\"SELECT datadate, gvkey, year, at, be, capx, oancf, txdb \"\n       \"FROM compustat\"),\n  con=tidy_finance,\n  parse_dates={\"datadate\"}\n)\n```\n:::\n\n\nThe classical investment regressions model is the capital investment of a firm as a function of operating cash flows and Tobin's q, a measure of a firm's investment opportunities.\\index{Cash flows}\\index{Regression!Investment} We start by constructing investment and cash flows which are usually normalized by lagged total assets of a firm. In the following code chunk, we construct a *panel* of firm-year observations, so we have both cross-sectional information on firms as well as time-series information for each firm.\\index{Regression!Panel}\n\n::: {#8d0c4eed .cell execution_count=4}\n``` {.python .cell-code}\ndata_investment = (compustat\n  .assign(\n    month=lambda x: (\n      pd.to_datetime(x[\"datadate\"]).dt.to_period(\"M\").dt.to_timestamp()\n    )\n  )\n  .merge(compustat.get([\"gvkey\", \"year\", \"at\"])\n         .rename(columns={\"at\": \"at_lag\"})\n         .assign(year=lambda x: x[\"year\"]+1), \n         on=[\"gvkey\", \"year\"], how=\"left\")\n  .query(\"at > 0 and at_lag > 0\")\n  .assign(investment=lambda x: x[\"capx\"]/x[\"at_lag\"],\n          cash_flows=lambda x: x[\"oancf\"]/x[\"at_lag\"])                   \n)\n\ndata_investment = (data_investment\n  .merge(data_investment.get([\"gvkey\", \"year\", \"investment\"])\n          .rename(columns={\"investment\": \"investment_lead\"})\n          .assign(year=lambda x: x[\"year\"]-1), \n         on=[\"gvkey\", \"year\"], how=\"left\")\n)\n```\n:::\n\n\nTobin's q is the ratio of the market value of capital to its replacement costs.\\index{Tobin's q} It is one of the most common regressors in corporate finance applications [e.g., @Fazzari1988; @Erickson2012]. We follow the implementation of @Gulen2015 and compute Tobin's q as the market value of equity (`mktcap`) plus the book value of assets (`at`) minus book value of equity (`be`) plus deferred taxes (`txdb`), all divided by book value of assets (`at`). Finally, we only keep observations where all variables of interest are non-missing, and the reported book value of assets is strictly positive.\n\n::: {#5a1e8c99 .cell execution_count=5}\n``` {.python .cell-code}\ndata_investment = (data_investment\n  .merge(crsp_monthly, on=[\"gvkey\", \"month\"], how=\"left\")\n  .assign(\n    tobins_q=lambda x: (\n      (x[\"mktcap\"]+x[\"at\"]-x[\"be\"]+x[\"txdb\"])/x[\"at\"]\n    )\n  )\n  .get([\"gvkey\", \"year\", \"investment_lead\", \"cash_flows\", \"tobins_q\"])\n  .dropna()\n)\n```\n:::\n\n\nAs the variable construction typically leads to extreme values that are most likely related to data issues (e.g., reporting errors), many papers include winsorization of the variables of interest. Winsorization involves replacing values of extreme outliers with quantiles on the respective end. The following function implements the winsorization for any percentage cut that should be applied on either end of the distributions.\\index{Winsorization} In the specific example, we winsorize the main variables (`investment`, `cash_flows`, and `tobins_q`) at the one percent level.^[Note that in `pandas`, when you index a data frame, you receive a reference to the original data frame. Consequently, modifying a subset will directly impact the initial data frame. To prevent unintended changes to the original data frame, it is advisable to use the `copy()` method as we do here in the `winsorize` function.]â€š\n\n::: {#0bb96b60 .cell execution_count=6}\n``` {.python .cell-code}\ndef winsorize(x, cut):\n    \"\"\"Winsorize returns at cut level.\"\"\"\n    \n    tmp_x = x.copy()\n    upper_quantile=np.nanquantile(tmp_x, 1 - cut)\n    lower_quantile=np.nanquantile(tmp_x, cut)\n    tmp_x[tmp_x > upper_quantile]=upper_quantile\n    tmp_x[tmp_x < lower_quantile]=lower_quantile\n    \n    return tmp_x\n\ndata_investment = (data_investment\n  .assign(\n    investment_lead=lambda x: winsorize(x[\"investment_lead\"], 0.01),\n    cash_flows=lambda x: winsorize(x[\"cash_flows\"], 0.01),\n    tobins_q=lambda x: winsorize(x[\"tobins_q\"], 0.01)\n  )\n)\n```\n:::\n\n\nBefore proceeding to any estimations, we highly recommend tabulating summary statistics of the variables that enter the regression. These simple tables allow you to check the plausibility of your numerical variables, as well as spot any obvious errors or outliers. Additionally, for panel data, plotting the time series of the variable's mean and the number of observations is a useful exercise to spot potential problems.\\index{Summary statistics}\n\n::: {#33c33647 .cell execution_count=7}\n``` {.python .cell-code}\ndata_investment_summary = (data_investment\n  .melt(id_vars=[\"gvkey\", \"year\"], var_name=\"measure\",\n        value_vars=[\"investment_lead\", \"cash_flows\", \"tobins_q\"])\n  .get([\"measure\", \"value\"])\n  .groupby(\"measure\")\n  .describe(percentiles=[0.05, 0.5, 0.95])\n)\nnp.round(data_investment_summary, 2)\n```\n\n::: {.cell-output .cell-output-display execution_count=7}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead tr th {\n        text-align: left;\n    }\n\n    .dataframe thead tr:last-of-type th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr>\n      <th></th>\n      <th colspan=\"8\" halign=\"left\">value</th>\n    </tr>\n    <tr>\n      <th></th>\n      <th>count</th>\n      <th>mean</th>\n      <th>std</th>\n      <th>min</th>\n      <th>5%</th>\n      <th>50%</th>\n      <th>95%</th>\n      <th>max</th>\n    </tr>\n    <tr>\n      <th>measure</th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>cash_flows</th>\n      <td>127450.0</td>\n      <td>0.01</td>\n      <td>0.27</td>\n      <td>-1.56</td>\n      <td>-0.47</td>\n      <td>0.06</td>\n      <td>0.27</td>\n      <td>0.48</td>\n    </tr>\n    <tr>\n      <th>investment_lead</th>\n      <td>127450.0</td>\n      <td>0.06</td>\n      <td>0.08</td>\n      <td>0.00</td>\n      <td>0.00</td>\n      <td>0.03</td>\n      <td>0.21</td>\n      <td>0.46</td>\n    </tr>\n    <tr>\n      <th>tobins_q</th>\n      <td>127450.0</td>\n      <td>2.00</td>\n      <td>1.70</td>\n      <td>0.57</td>\n      <td>0.79</td>\n      <td>1.39</td>\n      <td>5.37</td>\n      <td>10.90</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n## Fixed Effects \n\nTo illustrate fixed effects regressions, we use the `linearmodels` package, which is both computationally powerful and flexible with respect to model specifications.\\index{Regression!Fixed effects} We start out with the basic investment regression using the simple model\n$$ \\text{Investment}_{i,t+1} = \\alpha + \\beta_1\\text{Cash Flows}_{i,t}+\\beta_2\\text{Tobin's q}_{i,t}+\\varepsilon_{i,t},$${#eq-tobin-q}\nwhere $\\varepsilon_t$ is i.i.d. normally distributed across time and firms. We use the `PanelOLS()`-function to estimate the simple model so that the output has the same structure as the other regressions below. \n\n::: {#e8bb0be7 .cell execution_count=8}\n``` {.python .cell-code}\nmodel_ols = (lm.PanelOLS.from_formula(\n    formula=\"investment_lead ~ cash_flows + tobins_q + 1\",\n    data=data_investment.set_index([\"gvkey\", \"year\"]),\n  ).fit()\n)\nprettify_result(model_ols)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nPanel OLS Model:\ninvestment_lead ~ cash_flows + tobins_q + 1\n\nCovariance Type: Unadjusted\n\nCoefficients:\n            Estimate  Std. Error  t-Statistic  p-Value\nIntercept      0.042       0.000      127.480      0.0\ncash_flows     0.049       0.001       61.815      0.0\ntobins_q       0.007       0.000       57.045      0.0\n\nSummary statistics:\n- Number of observations: 127,450\n- R-squared (incl. FE): 0.043, Within R-squared: 0.039\n\n```\n:::\n:::\n\n\nAs expected, the regression output shows significant coefficients for both variables. Higher cash flows and investment opportunities are associated with higher investment. However, the simple model actually may have a lot of omitted variables, so our coefficients are most likely biased. As there is a lot of unexplained variation in our simple model (indicated by the rather low adjusted R-squared), the bias in our coefficients is potentially severe, and the true values could be above or below zero. Note that there are no clear cutoffs to decide when an R-squared is high or low, but it depends on the context of your application and on the comparison of different models for the same data. \n\nOne way to tackle the issue of omitted variable bias is to get rid of as much unexplained variation as possible by including *fixed effects* - i.e., model parameters that are fixed for specific groups [e.g., @Wooldridge2010]. In essence, each group has its own mean in fixed effects regressions. The simplest group that we can form in the investment regression is the firm level. The firm fixed effects regression is then\n$$ \\text{Investment}_{i,t+1} = \\alpha_i + \\beta_1\\text{Cash Flows}_{i,t}+\\beta_2\\text{Tobin's q}_{i,t}+\\varepsilon_{i,t},$${#eq-tobin-q-fe}\nwhere $\\alpha_i$ is the firm fixed effect and captures the firm-specific mean investment across all years. In fact, you could also compute firms' investments as deviations from the firms' average investments and estimate the model without the fixed effects. The idea of the firm fixed effect is to remove the firm's average investment, which might be affected by firm-specific variables that you do not observe. For example, firms in a specific industry might invest more on average. Or you observe a young firm with large investments but only small concurrent cash flows, which will only happen in a few years. This sort of variation is unwanted because it is related to unobserved variables that can bias your estimates in any direction.\n\nTo include the firm fixed effect, we use `gvkey` (Compustat's firm identifier) as follows:\n\n::: {#fa9862b9 .cell execution_count=9}\n``` {.python .cell-code}\nmodel_fe_firm = (lm.PanelOLS.from_formula(\n    formula=\"investment_lead ~ cash_flows + tobins_q + EntityEffects\",\n    data=data_investment.set_index([\"gvkey\", \"year\"]),\n  ).fit()\n)\nprettify_result(model_fe_firm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nPanel OLS Model:\ninvestment_lead ~ cash_flows + tobins_q + EntityEffects\n\nCovariance Type: Unadjusted\n\nCoefficients:\n            Estimate  Std. Error  t-Statistic  p-Value\ncash_flows     0.014       0.001       15.268      0.0\ntobins_q       0.011       0.000       82.006      0.0\n\nIncluded Fixed Effects:\n        Total\nEntity  14352\n\nSummary statistics:\n- Number of observations: 127,450\n- R-squared (incl. FE): 0.585, Within R-squared: 0.057\n\n```\n:::\n:::\n\n\nThe regression output shows a lot of unexplained variation at the firm level that is taken care of by including the firm fixed effect as the adjusted R-squared rises above 50%. In fact, it is more interesting to look at the within R-squared that shows the explanatory power of a firm's cash flow and Tobin's q *on top* of the average investment of each firm. We can also see that the coefficients changed slightly in magnitude but not in sign.\n\nThere is another source of variation that we can get rid of in our setting: average investment across firms might vary over time due to macroeconomic factors that affect all firms, such as economic crises. By including year fixed effects, we can take out the effect of unobservables that vary over time. The two-way fixed effects regression is then\n$$ \\text{Investment}_{i,t+1} = \\alpha_i + \\alpha_t + \\beta_1\\text{Cash Flows}_{i,t}+\\beta_2\\text{Tobin's q}_{i,t}+\\varepsilon_{i,t},$${#eq-tobin-q-2way}\nwhere $\\alpha_t$ is the time fixed effect. Here you can think of higher investments during an economic expansion with simultaneously high cash flows. You can include a time fixed effects by using \"TimeEffects\" in the formula of PanelOLS.\n\n::: {#64a425f5 .cell execution_count=10}\n``` {.python .cell-code}\nmodel_fe_firmyear = (lm.PanelOLS.from_formula(\n    formula=(\"investment_lead ~ cash_flows + tobins_q + EntityEffects\" \n             \" + TimeEffects\"),\n    data=data_investment.set_index([\"gvkey\", \"year\"]),\n  ).fit()\n)\nprettify_result(model_fe_firmyear)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nPanel OLS Model:\ninvestment_lead ~ cash_flows + tobins_q + EntityEffects + TimeEffects\n\nCovariance Type: Unadjusted\n\nCoefficients:\n            Estimate  Std. Error  t-Statistic  p-Value\ncash_flows     0.018       0.001       19.410      0.0\ntobins_q       0.010       0.000       75.332      0.0\n\nIncluded Fixed Effects:\n        Total\nEntity  14352\nTime       35\n\nSummary statistics:\n- Number of observations: 127,450\n- R-squared (incl. FE): 0.607, Within R-squared: 0.057\n\n```\n:::\n:::\n\n\nThe inclusion of time fixed effects did only marginally affect the R-squared and the coefficients, which we can interpret as a good thing as it indicates that the coefficients are not driven by an omitted variable that varies over time. \n\nHow can we further improve the robustness of our regression results? Ideally, we want to get rid of unexplained variation at the firm-year level, which means we need to include more variables that vary across firm *and* time and are likely correlated with investment. Note that we cannot include firm-year fixed effects in our setting because then cash flows and Tobin's q are colinear with the fixed effects, and the estimation becomes void. \n\nBefore we discuss the properties of our estimation errors, we want to point out that regression tables are at the heart of every empirical analysis, where you compare multiple models. Fortunately, the `results.compare()` function provides a convenient way to tabulate the regression output (with many parameters to customize and even print the output in LaTeX). We recommend printing $t$-statistics rather than standard errors in regression tables because the latter are typically very hard to interpret across coefficients that vary in size. We also do not print p-values because they are sometimes misinterpreted to signal the importance of observed effects [@Wasserstein2016]. The $t$-statistics provide a consistent way to interpret changes in estimation uncertainty across different model specifications.\n\n::: {#39f636e5 .cell execution_count=11}\n``` {.python .cell-code}\nprettify_result([model_ols, model_fe_firm, model_fe_firmyear])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nDependent var.  investment_lead  investment_lead  investment_lead\n\nIntercept       0.042 (127.48)\ncash_flows       0.049 (61.82)    0.014 (15.27)    0.018 (19.41)\ntobins_q         0.007 (57.04)    0.011 (82.01)    0.01 (75.33)\n\nFixed effects                        Entity        Entity, Time\nVCOV type         Unadjusted       Unadjusted       Unadjusted\nObservations        127,450          127,450          127,450\nR2 (incl. FE)        0.043            0.585            0.607\nWithin R2            0.039            0.057            0.057\n\nNote: t-statistics in parentheses\n```\n:::\n:::\n\n\n## Clustering Standard Errors\n\nApart from biased estimators, we usually have to deal with potentially complex dependencies of our residuals with each other. Such dependencies in the residuals invalidate the i.i.d. assumption of OLS and lead to biased standard errors. With biased OLS standard errors, we cannot reliably interpret the statistical significance of our estimated coefficients. \n\nIn our setting, the residuals may be correlated across years for a given firm (time-series dependence), or, alternatively, the residuals may be correlated across different firms (cross-section dependence). One of the most common approaches to dealing with such dependence is the use of *clustered standard errors* [@Petersen2008].\\index{Standard errors!Clustered} The idea behind clustering is that the correlation of residuals *within* a cluster can be of any form. As the number of clusters grows, the cluster-robust standard errors become consistent [@Lang2007;@Wooldridge2010]. A natural requirement for clustering standard errors in practice is hence a sufficiently large number of clusters. Typically, around at least 30 to 50 clusters are seen as sufficient [@Cameron2011].\n\nInstead of relying on the i.i.d. assumption, we can use the `cov_type=\"clustered\"` option in the `fit()`-function as above. The code chunk below applies both one-way clustering by firm as well as two-way clustering by firm and year.\n\n::: {#807a31ba .cell execution_count=12}\n``` {.python .cell-code}\nmodel_cluster_firm = lm.PanelOLS.from_formula(\n  formula=(\"investment_lead ~ cash_flows + tobins_q + EntityEffects\"\n           \" + TimeEffects\"),\n  data=data_investment.set_index([\"gvkey\", \"year\"]),\n).fit(cov_type=\"clustered\", cluster_entity=True, cluster_time=False)\n\nmodel_cluster_firmyear = lm.PanelOLS.from_formula(\n  formula=(\"investment_lead ~ cash_flows + tobins_q + EntityEffects\"\n           \" + TimeEffects\"),\n  data=data_investment.set_index([\"gvkey\", \"year\"]),\n).fit(cov_type=\"clustered\", cluster_entity=True, cluster_time=True)\n```\n:::\n\n\n\\index{Robustness tests}\nThe table below shows the comparison of the different assumptions behind the standard errors. In the first column, we can see highly significant coefficients on both cash flows and Tobin's q. By clustering the standard errors on the firm level, the $t$-statistics of both coefficients drop in half, indicating a high correlation of residuals within firms. If we additionally cluster by year, we see a drop, particularly for Tobin's q, again. Even after relaxing the assumptions behind our standard errors, both coefficients are still comfortably significant as the $t$ statistics are well above the usual critical values of 1.96 or 2.576 for two-tailed significance tests.\n\n::: {#293cde90 .cell execution_count=13}\n``` {.python .cell-code}\nprettify_result([\n  model_fe_firmyear, model_cluster_firm, model_cluster_firmyear\n])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nDependent var.  investment_lead  investment_lead  investment_lead\n\ncash_flows       0.018 (19.41)    0.018 (10.6)     0.018 (9.14)\ntobins_q         0.01 (75.33)     0.01 (33.37)     0.01 (14.68)\n\nFixed effects    Entity, Time     Entity, Time     Entity, Time\nVCOV type         Unadjusted        Clustered        Clustered\nObservations        127,450          127,450          127,450\nR2 (incl. FE)        0.607            0.607            0.607\nWithin R2            0.057            0.057            0.057\n\nNote: t-statistics in parentheses\n```\n:::\n:::\n\n\nInspired by @AbadieEtAl2017, we want to close this chapter by highlighting that choosing the right dimensions for clustering is a design problem. Even if the data is informative about whether clustering matters for standard errors, they do not tell you whether you should adjust the standard errors for clustering. Clustering at too aggregate levels can hence lead to unnecessarily inflated standard errors. \n\n## Exercises\n\n1. Estimate the two-way fixed effects model with two-way clustered standard errors using quarterly Compustat data from WRDS.\n1. Following @Peters2017, compute Tobin's q as the market value of outstanding equity `mktcap` plus the book value of debt (`dltt` + `dlc`) minus the current assets `atc` and everything divided by the book value of property, plant and equipment `ppegt`. What is the correlation between the measures of Tobin's q? What is the impact on the two-way fixed effects regressions?\n\n",
    "supporting": [
      "fixed-effects-and-clustered-standard-errors_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}