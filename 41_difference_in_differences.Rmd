# Difference in differences

In this chapter, we introduce difference in differences designs to evaluate the effects of climate change regulation on the pricing of bonds across firms. 

The current chapter relies on this set of packages. 
```{r}
library(tidyverse)
library(lubridate)
library(RSQLite)
library(fixest)
library(broom)
```

Paris Agreement as December 12, 2015

## Data preparation

We use TRACE and Mergent FISD as data sources from our `SQLite`-database introduced in chapters 2-3. \index{Data!CRSP}\index{Data!Compustat}

```{r}
tidy_finance <- dbConnect(
  SQLite(), 
  "data/tidy_finance.sqlite",
  extended_types = TRUE
)

mergent <- tbl(tidy_finance, "mergent") |> 
  collect()

trace_enhanced <- tbl(tidy_finance, "trace_enhanced") |>
  collect()

```


```{r}
treatment_date <- ymd("2015-12-12")

mergent <- mergent |> 
  mutate(time_maturity = as.numeric(maturity - treatment_date) / 365,
         sic_code = as.integer(substr(sic_code, 1, 2)),
         offering_amt = log(offering_amt)) |> 
  filter(time_maturity >= 1) |> 
  select(cusip_id = complete_cusip, 
         time_maturity, offering_amt, sic_code)

trace_enhanced <- trace_enhanced |> 
  filter(rptd_pr > 25)
```

aggregate transactions

```{r}
trace_aggregated <- trace_enhanced |> 
  group_by(cusip_id, trd_exctn_dt) |> 
  summarize(
    avg_yield = weighted.mean(yld_pt, entrd_vol_qt * rptd_pr),
    trades = n(), 
    .groups = "drop") |> 
  drop_na(avg_yield) |> 
  filter(trades >= 5) |> 
  mutate(month = floor_date(trd_exctn_dt, "months")) |> 
  group_by(cusip_id, month) |> 
  slice_max(trd_exctn_dt) |> 
  ungroup() |> 
  select(cusip_id, month, avg_yield)
```

add FISD data, identify polluting industries

```{r}
polluting_industries <- c(49, 13, 45, 29, 28, 33, 40, 20, 
                          26, 42, 10, 53, 32, 99, 37) 

data_bond <- trace_aggregated |> 
  inner_join(mergent, by = "cusip_id") |> 
  mutate(polluter = sic_code %in% polluting_industries)
```


```{r}
treatment_date_index <- which(sort(unique(data_bond$month)) ==
                                floor_date(treatment_date, "months"))

data_bond <- data_bond |> 
  mutate(post_period = month >= floor_date(treatment_date, "months"),
         month = as.factor(month),
         month = fct_rev(relevel(month, ref = treatment_date_index)))
```

```{r}
data_bond <- data_bond |> 
  mutate(treated = polluter & post_period)
```


Before proceeding to any estimations, we tabulate summary statistics of the variables that enter the regression.\index{Summary statistics}

```{r}
data_bond |>
  pivot_longer(cols = c(avg_yield, time_maturity, offering_amt), 
               names_to = "measure") |> 
  group_by(measure) |>
  summarize(mean = mean(value),
            sd = sd(value),
            min = min(value),
            q05 = quantile(value, 0.05),
            q25 = quantile(value, 0.25),
            q50 = quantile(value, 0.50),
            q75 = quantile(value, 0.75),
            q95 = quantile(value, 0.95),
            max = max(value),
            n = n(),
            .groups = "drop")
```

## Run regression

Classical diff in diff: control for unobservable individual and time effects:
```{r}
model_diff <- feols(
  fml = avg_yield ~ treated | cusip_id + month,
  cluster = "cusip_id",
  data = data_bond
)
model_diff
```
Result indicates  that polluters have significantly higher yields after Paris agreement thatn non polluters.

```{r}
data_bond
```


```{r, fig411, fig.cap = "The figure shows the coefficient estimates and 95%-confidence intervals for OLS regressions estimating the treatment effect of the Paris Climate Agrement on bond yields (in %) for polluters and non-polluters. The horizontal line represents the benchmark yield of polluters before the Paris Agreement. The vertical line indicates the date of agreement (December 12, 2015).", fig.alt = "Title: Polluters respond stronger to Paris Agreement than green firms. The figure shows a sequence of monthly dots for two groups. Before the agreement, the dots mainly overlap. Ahead of the agreement, yields start to increase. Then, after the agreement there is a strong divergence in yields. Polluters have significantly higher yields than non-polluters in the months before and after the signing of the Paris Agreement. However, this yield difference vanishes again towards the end of 2016."}
model_diff_months <- feols(
  fml = avg_yield ~ month:polluter + time_maturity + offering_amt,
  se = "iid",
  data = data_bond
)

coefficients <- broom::tidy(model_diff_months) |> 
  filter(str_detect(term, "month")) |> 
  mutate(month = ymd(substr(term, 6, 16)),
         treatment = substr(term, 25, nchar(term)),
         ci_up = estimate + qnorm(0.975)*std.error,
         ci_low = estimate + qnorm(0.025)*std.error)


coefficients |> ggplot(aes(month, color = treatment)) +
  geom_vline(aes(xintercept = ymd("2015-12-12")),
             linetype = "dashed") +
  geom_hline(aes(yintercept = 0),
             linetype = "dashed") +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_up),
                alpha = 0.5) +
  geom_point(aes(y = estimate)) +
  labs(x = NULL,
       y = "Yield",
       color = "Polluter?",
       title = "Polluters respond stronger to Paris Agreement than green firms")
```

Alternative plot with fixed effects
```{r}
# Create dummy variables
treatment_date_floor <- floor_date(treatment_date, "month")
data_bond_alt <- data_bond %>% 
  mutate(month = ymd(month),
         diff_to_treatment = interval(treatment_date_floor, month) %/% months(1))
variables <- data_bond_alt %>% 
  distinct(diff_to_treatment, month) %>% 
  arrange(month) %>% 
  mutate(variable_name = as.character(NA))
formula <- "avg_yield ~ "
for (j in 1:nrow(variables)) {
  if (variables$diff_to_treatment[j] != 0) {
    old_names <- names(data_bond_alt)
    data_bond_alt <- data_bond_alt %>% 
      mutate(new_var = diff_to_treatment == variables$diff_to_treatment[j] & polluter)
    new_var_name <- ifelse(variables$diff_to_treatment[j]<0, 
                         str_c("lag", abs(variables$diff_to_treatment[j])),
                         str_c("lead", variables$diff_to_treatment[j]))
    variables$variable_name[j] <- new_var_name
    names(data_bond_alt) <- c(old_names, new_var_name)
    formula <- str_c(formula, 
                     ifelse(j == 1, 
                            new_var_name, 
                            str_c("+", new_var_name)))
  }
}
# data_bond_alt <- data_bond_alt %>% 
#   select(cusip_id, month, avg_yield,
#          contains("lag"), contains("lead"))
formula <- str_c(formula, "| cusip_id + month")
model_diff_months_alt <- feols(
  fml = as.formula(formula),
  cluster = "cusip_id",
  data = data_bond_alt
)
etable(model_diff_months_alt)

coefs <- broom::tidy(model_diff_months_alt) |> 
  # filter(str_detect(term, "month")) |> 
  mutate(term = str_remove(term, "TRUE"),
         ci_up = estimate + qnorm(0.975)*std.error,
         ci_low = estimate + qnorm(0.025)*std.error) %>% 
  bind_rows(tibble(
    term = "lag0",
    estimate = 0,
    ci_up = 0,
    ci_low = 0,
  )) %>% 
  left_join(
    variables, by = c("term"="variable_name")
  ) %>% 
  mutate(month = if_else(term=="lag0", treatment_date_floor, month))

coefs %>% 
  ggplot(aes(x = month, y = estimate)) +
  geom_vline(aes(xintercept = ymd("2015-12-12")),
             linetype = "dashed") +
  geom_hline(aes(yintercept = 0),
             linetype = "dashed") +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_up),
                alpha = 0.5) +
  geom_point(aes(y = estimate)) +
  labs(x = NULL,
       y = "Yield",
       title = "Polluters respond stronger to Paris Agreement than green firms")

```

