# Difference in differences

The current chapter relies on this set of packages. 
```{r}
library(tidyverse)
library(lubridate)
library(RSQLite)
library(fixest)
```

Paris Agreement as December 12, 2015

## Data preparation

We use TRACE and Mergent FISD as data sources from our `SQLite`-database introduced in our chapter on *"Accessing & managing financial data"*. \index{Data!CRSP}\index{Data!Compustat}

```{r}
tidy_finance <- dbConnect(
  SQLite(), 
  "data/tidy_finance.sqlite",
  extended_types = TRUE
)

treatment_date <- as.Date("2015-12-12")

mergent <- tbl(tidy_finance, "mergent") |> 
  collect() |> 
  mutate(time_maturity = as.numeric(maturity - treatment_date)/365,
         sic_code = substr(sic_code, 1, 2),
         offering_amt = log(offering_amt)) |> 
  filter(time_maturity >= 1) |> 
  select(cusip_id = complete_cusip, 
         time_maturity, offering_amt, sic_code)

trace_enhanced <- tbl(tidy_finance, "trace_enhanced") |>
  collect() |> 
  filter(rptd_pr > 25)
```

aggregate transactions

```{r}
trace_aggregated <- trace_enhanced |> 
  group_by(cusip_id, trd_exctn_dt) |> 
  summarize(avg_yield = weighted.mean(yld_pt, 
                                      entrd_vol_qt * rptd_pr),
            trades = n(), 
            .groups = "drop") |> 
  drop_na(avg_yield) |> 
  filter(trades >= 5) |> 
  mutate(month = floor_date(trd_exctn_dt, "months")) |> 
  group_by(cusip_id, month) |> 
  slice_max(trd_exctn_dt) |> 
  ungroup() |> 
  select(cusip_id, month, avg_yield)
```

add FISD data, identify polluting industries

```{r}
polluting_industries <- c(49, 13, 45, 29, 28, 33, 40, 20, 
                          26, 42, 10, 53, 32, 99, 37) |> 
  as.character()

data_bond <- trace_aggregated |> 
  inner_join(mergent, by = "cusip_id") |> 
  mutate(polluter = sic_code %in% polluting_industries) |> 
  select(-sic_code)
```


```{r}
treatment_date_index <- which(sort(unique(data_bond$month)) ==
                                floor_date(treatment_date, "months"))

data_bond <- data_bond |> 
  mutate(post_period = month >= floor_date(treatment_date, "months"),
         month = as.factor(month),
         month = fct_rev(relevel(month, ref = treatment_date_index)))
```

```{r}
data_bond <- data_bond |> 
  mutate(treated = polluter & post_period)
```


Before proceeding to any estimations, we tabulate summary statistics of the variables that enter the regression.\index{Summary statistics}

```{r}
data_bond |>
  pivot_longer(cols = c(avg_yield, time_maturity, offering_amt), 
               names_to = "measure") |> 
  group_by(measure) |>
  summarize(mean = mean(value),
            sd = sd(value),
            min = min(value),
            q05 = quantile(value, 0.05),
            q25 = quantile(value, 0.25),
            q50 = quantile(value, 0.50),
            q75 = quantile(value, 0.75),
            q95 = quantile(value, 0.95),
            max = max(value),
            n = n(),
            .groups = "drop")
```

## Run regression

```{r}
model_diff <- feols(
  fml = avg_yield ~ treated + offering_amt + time_maturity | 
    post_period + polluter,
  se = "iid",
  data = data_bond
)
model_diff
```

```{r, fig.cap = "The figure shows the coefficient estimates and 95%-confidence intervals for OLS regressions estimating the treatment effect of the Paris Climate Agrement on bond yields (in %) for polluters and non-polluters. The horizontal line represents the benchmark yield of polluters before the Paris Agreement. The vertical line indicates the date of agreement (December 12, 2015).", fig.alt = "Title: Polluters respond stronger to Paris Agreement than green firms. The figure shows a sequence of monthly dots for two groups. Before the agreement, the dots mainly overlap. Ahead of the agreement, yields start to increase. Then, after the agreement there is a strong divergence in yields. Polluters have significantly higher yields than non-polluters."}
model_diff_months <- feols(
  fml = avg_yield ~ offering_amt + time_maturity + month:polluter,
  se = "iid",
  data = data_bond
)

coefficients <- broom::tidy(model_diff_months) |> 
  filter(str_detect(term, "month")) |> 
  mutate(month = ymd(substr(term, 6, 16)),
         treatment = substr(term, 25, nchar(term)),
         ci_up = estimate + qnorm(0.975)*std.error,
         ci_low = estimate + qnorm(0.025)*std.error)


coefficients |> ggplot(aes(month, color = treatment)) +
  geom_vline(aes(xintercept = as.Date("2015-12-12")),
             linetype = "dashed") +
  geom_hline(aes(yintercept = 0),
             linetype = "dashed") +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_up),
                alpha = 0.5) +
  geom_point(aes(y = estimate)) +
  labs(x = NULL,
       y = "Yield",
       color = "Polluter?",
       title = "Polluters respond stronger to Paris Agreement than green firms")
```

