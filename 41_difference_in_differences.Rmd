# Difference in differences

In this chapter, we illustrate the concept of *difference in differences* (DD) estimators by evaluating the effects of climate change regulation on the pricing of bonds across firms. DD estimators are typically used to recover the treatment effects of natural or quasi-natural experiments that trigger sharp changes in the environment of a specific group. Such experiments are usually exploited to address endogeneity concerns [e.g. @RobertsWhited2013]. In the context of our setting, we investigate the impact of the Paris Agreement from December 12, 2015 on the bond yields of polluting firms. We first estimate the treatment effect of the agreement using panel regression techniques that we discussed in the previous chapter. We then present two methods to graphically illustrate the treatment effect over time. Although we demonstrate that the treatment effect of the agreement is anticipated by bond market participants well in advance, the techniques we present below can also be applied to many other settings. 

The current chapter relies on this set of packages. 

```{r}
library(tidyverse)
library(lubridate)
library(RSQLite)
library(fixest)
library(broom)
```

## Data preparation

We use TRACE and Mergent FISD as data sources from our `SQLite`-database introduced in chapter 4. \index{Data!CRSP}\index{Data!Compustat}

```{r}
tidy_finance <- dbConnect(
  SQLite(), 
  "data/tidy_finance.sqlite",
  extended_types = TRUE
)

mergent <- tbl(tidy_finance, "mergent") |> 
  collect()

trace_enhanced <- tbl(tidy_finance, "trace_enhanced") |>
  collect()

```

We start our analysis by preparing the sample of bonds: we only consider bonds with a time to maturity of more than 1 year to the signing of the Paris Agreement to exclude all bonds that were issued after the agreement and so close to the agreement that the treatment effect could already be priced in. We also consider only the first two digits of the SIC industry code, which we use to identify the polluting industries.

```{r}
treatment_date <- ymd("2015-12-12")

bonds <- mergent |> 
  mutate(time_to_maturity = as.numeric(maturity - treatment_date) / 365,
         sic_code = as.integer(substr(sic_code, 1, 2)),
         log_offering_amt = log(offering_amt)) |> 
  filter(time_to_maturity >= 1) |> 
  select(cusip_id = complete_cusip, 
         time_to_maturity, log_offering_amt, sic_code)

polluting_industries <- c(49, 13, 45, 29, 28, 33, 40, 20, 
                          26, 42, 10, 53, 32, 99, 37) 

bonds <- bonds |> 
  mutate(polluter = sic_code %in% polluting_industries)
```

Next, we aggregate the individual transactions as reported in TRACE to a monthly panel of bond yields. We only consider transactions with a reported price `rptd_pr` larger than 25 (TODO: WHY??) and only bond-day observations with more than 5 trades on the corresponding day (TODO: WHY??).

```{r}
trace_aggregated <- trace_enhanced |> 
  filter(rptd_pr > 25) |>
  group_by(cusip_id, trd_exctn_dt) |> 
  summarize(
    avg_yield = weighted.mean(yld_pt, entrd_vol_qt * rptd_pr),
    trades = n(), 
    .groups = "drop") |> 
  drop_na(avg_yield) |> 
  filter(trades >= 5) |> 
  mutate(month = floor_date(trd_exctn_dt, "months")) |> 
  group_by(cusip_id, month) |> 
  slice_max(trd_exctn_dt) |> 
  ungroup() |> 
  select(cusip_id, month, avg_yield)
```

By combining the bond sample with the aggregated TRACE data, we arrive at the main sample for our analysis.

```{r}
bonds_panel <- bonds |> 
  inner_join(trace_aggregated, by = "cusip_id") |>
  drop_na()
```

Before we can run the first regression, we need to define the `treated` indicator which is a product of the `post_period` (i.e., all months after the signing of the Paris Agreement) and the `polluter` indicator that we defined above. 

```{r}
bonds_panel <- bonds_panel |> 
  mutate(post_period = month >= floor_date(treatment_date, "months"))

bonds_panel <- bonds_panel |> 
  mutate(treated = polluter & post_period)
```

As usual, we tabulate summary statistics of the variables that enter the regression to check the validity of our variable definitions.\index{Summary statistics}

```{r}
bonds_panel |>
  pivot_longer(cols = c(avg_yield, time_to_maturity, log_offering_amt), 
               names_to = "measure") |> 
  group_by(measure) |>
  summarize(mean = mean(value),
            sd = sd(value),
            min = min(value),
            q05 = quantile(value, 0.05),
            q25 = quantile(value, 0.25),
            q50 = quantile(value, 0.50),
            q75 = quantile(value, 0.75),
            q95 = quantile(value, 0.95),
            max = max(value),
            n = n(),
            .groups = "drop")
```

## Panel regressions

We first run an OLS regression without fixed effects where we simply include the `treated`, `post_period` and `polluter` dummies, as well as the bond-specific characteristics `log_offering_amt` and `time_to_maturity`. This simple model assumes that there are essentially two periods (before and after the PA) and two groups (polluters and non-polluters). Nonetheless, it should indicate whether polluters have higher yields following the Paris Agreement compared to non-polluters. 

The second model follows the typical DD regression approach by including individual (`cusip_id`) and time (`month`) fixed effects. In this model, we do not include any other variables from the simple model because they are subsumed by the fixed effects and we are left with the coefficient of our main variable of interest: `treated`. 
```{r}
model_without_fe <- feols(
  fml = avg_yield ~ treated + post_period + polluter + 
    log_offering_amt + time_to_maturity,
  vcov = "iid",
  data = bonds_panel
)

model_with_fe <- feols(
  fml = avg_yield ~ treated | cusip_id + month,
  vcov = "iid",
  data = bonds_panel
)

etable(model_without_fe, model_with_fe, coefstat = "tstat")
```
Both models indicate that polluters have significantly higher yields after the Paris agreement than non polluting firms. Note that the magnitude of the `treated` coefficient varies considerably across models. 

## Visualizing parallel trends

Even though the regressions above indicate that there is an impact of the Paris Agreement on bond yields of polluters, the tables do not tell us anything about the dynamics of the treatment effect. In particular, the models provide no indication about whether the crucial *parallel trends* assumption is valid. This assumption requires that in the absence of treatment, the difference between the two groups is constant over time. Although there is no well defined statistical test for this assumption, visual inspection typically provides decisive evidence.

To provide such visual evidence, we revisit the simple OLS model and replace the `treated` and `post_period` indicators by month dummies for each group. This approach estimates the average yield change of both groups for each period and provides corresponding confidence intervals. Plotting the coefficient estimates for both groups around the treatment date shows us the dynamics of our panel data. 
```{r, fig411, fig.cap = "The figure shows the coefficient estimates and 95%-confidence intervals for OLS regressions estimating the treatment effect of the Paris Climate Agrement on bond yields (in %) for polluters and non-polluters. The horizontal line represents the benchmark yield of polluters before the Paris Agreement. The vertical line indicates the date of agreement (December 12, 2015).", fig.alt = "Title: Polluters respond stronger to Paris Agreement than green firms. The figure shows a sequence of monthly dots for two groups. Before the agreement, the dots mainly overlap. Ahead of the agreement, yields start to increase. Then, after the agreement there is a strong divergence in yields. Polluters have significantly higher yields than non-polluters in the months before and after the signing of the Paris Agreement. However, this yield difference vanishes again towards the end of 2016."}
model_without_fe_time <- feols(
  fml = avg_yield ~ polluter + month:polluter + 
    time_to_maturity + log_offering_amt,
  vcov = "iid",
  data = bonds_panel |>
    mutate(month = factor(month))
)

model_without_fe_coefs <- tidy(model_without_fe_time) |> 
  filter(str_detect(term, "month")) |> 
  mutate(month = ymd(substr(term, nchar(term)-9, nchar(term))),
         treatment = str_detect(term, "TRUE"),
         ci_up = estimate + qnorm(0.975)*std.error,
         ci_low = estimate + qnorm(0.025)*std.error)


model_without_fe_coefs |> 
  ggplot(aes(month, color = treatment)) +
  geom_vline(aes(xintercept = floor_date(treatment_date, "month")),
             linetype = "dashed") +
  geom_hline(aes(yintercept = 0),
             linetype = "dashed") +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_up),
                alpha = 0.5) +
  geom_point(aes(y = estimate)) +
  labs(x = NULL,
       y = "Yield",
       color = "Polluter?",
       title = "Polluters respond stronger to Paris Agreement than green firms")
```
We can see that throughout most of 2014 the yields of the two groups changed in unison. However, starting in the end of 2014, the yields start to diverge reaching the highest difference around the signing of the Paris Agreement. Afterwards, the yields for both groups fall again and the polluters arrive at the same level as in the beginning of 2014. The non-polluters, on the other hand, even experience significantly lower yields than polluters after the singing of the agreement. 

Instead of plotting both groups using the simple model approach, we can also use the fixed-effects model and focus on the polluters yield response to the signing relative to the non-polluters. To perform this estimation, we need to replace the `treated` indicator with separate time dummies for the polluters, each marking a one-month period relative to the treatment date. We then regress the monthly yields on the set of time dummies and `cusip_id` and `month` fixed effects. 
```{r}
bonds_panel_alt <- bonds_panel %>% 
  mutate(
    diff_to_treatment = interval(
      floor_date(treatment_date, "month"), month) %/% months(1)
    )
variables <- bonds_panel_alt %>% 
  distinct(diff_to_treatment, month) %>% 
  arrange(month) %>% 
  mutate(variable_name = as.character(NA))
formula <- "avg_yield ~ "
for (j in 1:nrow(variables)) {
  if (variables$diff_to_treatment[j] != 0) {
    old_names <- names(bonds_panel_alt)
    bonds_panel_alt <- bonds_panel_alt %>% 
      mutate(new_var = diff_to_treatment == variables$diff_to_treatment[j] & polluter)
    new_var_name <- ifelse(variables$diff_to_treatment[j]<0, 
                         str_c("lag", abs(variables$diff_to_treatment[j])),
                         str_c("lead", variables$diff_to_treatment[j]))
    variables$variable_name[j] <- new_var_name
    names(bonds_panel_alt) <- c(old_names, new_var_name)
    formula <- str_c(formula, 
                     ifelse(j == 1, 
                            new_var_name, 
                            str_c("+", new_var_name)))
  }
}
formula <- str_c(formula, "| cusip_id + month")

model_with_fe_time <- feols(
  fml = as.formula(formula),
  vcov = "iid",
  data = data_bond_alt
)

model_with_fe_time_coefs <- tidy(model_with_fe_time) |> 
  mutate(term = str_remove(term, "TRUE"),
         ci_up = estimate + qnorm(0.975)*std.error,
         ci_low = estimate + qnorm(0.025)*std.error) %>% 
  bind_rows(tibble(
    term = "lag0",
    estimate = 0,
    ci_up = 0,
    ci_low = 0,
  )) %>% 
  left_join(
    variables, by = c("term" = "variable_name")
  ) %>% 
  mutate(month = if_else(term == "lag0", 
                         floor_date(treatment_date, "month"), 
                         month))

model_with_fe_time_coefs %>% 
  ggplot(aes(x = month, y = estimate)) +
  geom_vline(aes(xintercept = treatment_date_floor),
             linetype = "dashed") +
  geom_hline(aes(yintercept = 0),
             linetype = "dashed") +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_up),
                alpha = 0.5) +
  geom_point(aes(y = estimate)) +
  labs(x = NULL,
       y = "Yield",
       title = "Polluters yield patterns around Paris Agreement signing")
```

The resulting figure confirms the main conclusion of the previous image: polluters yield patterns show a considerable anticipation effect starting towards the end of 2014. Yields only marginally increase after the singing of the agreement. However, as opposed to the simple model, we do not see a complete reversal back to the pre agreement level. Yields of polluters stay at a significantly higher level even one year after the signing.

## Exercises

TODO: INSERT EXERCISES
